{% extends "base.html" %}

{% block title %}{{ student.full_name }} - Student Profile{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Student Profile Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 bg-gradient-info text-white">
                <div class="card-body p-4">
                    <div class="row align-items-center">
                        <div class="col-md-2">
                            <div class="student-avatar">
                                {% if student.profile_picture %}
                                    <img src="{{ url_for('static', filename='uploads/' + student.profile_picture) }}" alt="Student Photo" class="rounded-circle">
                                {% else %}
                                    <div class="avatar-placeholder">
                                        <i class="fas fa-user-graduate fa-3x"></i>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-7">
                            <h1 class="h3 mb-2 text-white">
                                <i class="fas fa-user-graduate me-3"></i>
                                {{ student.full_name }}
                            </h1>
                            <p class="mb-1 opacity-75">
                                <strong>Student ID:</strong> {{ student.student_id }}
                                {% if student.grade %} | <strong>Grade:</strong> {{ student.grade }}{% endif %}
                                {% if student.school %} | <strong>School:</strong> {{ student.school }}{% endif %}
                            </p>
                            <div class="d-flex gap-2 mt-2">
                                <span class="badge bg-light text-dark">
                                    <i class="fas fa-calendar me-1"></i>
                                    {% if student.age %}{{ student.age }} years old{% else %}Age not specified{% endif %}
                                </span>
                                <span class="badge bg-{{ 'success' if student.status == 'active' else 'warning' }}">
                                    <i class="fas fa-circle me-1"></i>
                                    {{ student.status|title }}
                                </span>
                            </div>
                        </div>
                        <div class="col-md-3 text-end">
                            <div class="btn-group-vertical d-grid gap-2">
                                {% if current_user.role in ['superadmin', 'admin', 'coordinator'] %}
                                <a href="{{ url_for('edit_student', id=student.id) }}" class="btn btn-light btn-sm">
                                    <i class="fas fa-edit me-1"></i> Edit Profile
                                </a>
                                <a href="{{ url_for('enroll_student_route', id=student.id) }}" class="btn btn-outline-light btn-sm">
                                    <i class="fas fa-plus me-1"></i> New Enrollment
                                </a>
                                {% endif %}
                                <a href="{{ url_for('students') }}" class="btn btn-outline-light btn-sm">
                                    <i class="fas fa-arrow-left me-1"></i> Back to List
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Student Information Grid -->
    <div class="row g-4 mb-4">
        <!-- Personal Information -->
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-transparent border-0 pb-0">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-user text-primary me-2"></i>
                        Personal Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-sm-6">
                            <div class="info-item">
                                <label class="text-muted small">Full Name</label>
                                <div class="fw-bold">{{ student.full_name }}</div>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="info-item">
                                <label class="text-muted small">Student ID</label>
                                <div class="fw-bold text-primary">{{ student.student_id }}</div>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="info-item">
                                <label class="text-muted small">Date of Birth</label>
                                <div class="fw-bold">
                                    {{ student.date_of_birth.strftime('%B %d, %Y') if student.date_of_birth else 'Not specified' }}
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="info-item">
                                <label class="text-muted small">Gender</label>
                                <div class="fw-bold">{{ student.gender|title if student.gender else 'Not specified' }}</div>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="info-item">
                                <label class="text-muted small">Email</label>
                                <div class="fw-bold">
                                    {% if student.email %}
                                        <a href="mailto:{{ student.email }}" class="text-decoration-none">
                                            <i class="fas fa-envelope me-1"></i>{{ student.email }}
                                        </a>
                                    {% else %}
                                        Not provided
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="info-item">
                                <label class="text-muted small">Phone</label>
                                <div class="fw-bold">
                                    {% if student.phone %}
                                        <a href="tel:{{ student.phone }}" class="text-decoration-none">
                                            <i class="fas fa-phone me-1"></i>{{ student.phone }}
                                        </a>
                                    {% else %}
                                        Not provided
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Academic Information -->
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-transparent border-0 pb-0">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-graduation-cap text-success me-2"></i>
                        Academic Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-sm-6">
                            <div class="info-item">
                                <label class="text-muted small">Current Grade</label>
                                <div class="fw-bold">{{ student.grade or 'Not specified' }}</div>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="info-item">
                                <label class="text-muted small">School/Institution</label>
                                <div class="fw-bold">{{ student.school or 'Not specified' }}</div>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="info-item">
                                <label class="text-muted small">Board</label>
                                <div class="fw-bold">{{ student.board or 'Not specified' }}</div>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="info-item">
                                <label class="text-muted small">Department</label>
                                <div class="fw-bold">
                                    {% if student.department %}
                                        <span class="badge bg-primary">{{ student.department.name }}</span>
                                    {% else %}
                                        Not assigned
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="info-item">
                                <label class="text-muted small">Learning Goals</label>
                                <div class="fw-bold">{{ student.learning_goals or 'Not specified' }}</div>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="info-item">
                                <label class="text-muted small">Address</label>
                                <div class="fw-bold">
                                    {% if student.address %}
                                        <i class="fas fa-map-marker-alt me-1 text-muted"></i>
                                        {{ student.address }}
                                    {% else %}
                                        Not provided
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Parent/Guardian Information -->
    {% if parents %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-users text-warning me-2"></i>
                        Parent/Guardian Information
                    </h5>
                    {% if current_user.role in ['superadmin', 'admin', 'coordinator'] %}
                    <button class="btn btn-sm btn-outline-primary" onclick="addParentModal()">
                        <i class="fas fa-plus me-1"></i> Add Parent
                    </button>
                    {% endif %}
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        {% for parent in parents %}
                        <div class="col-md-6">
                            <div class="parent-card p-3 border rounded">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="mb-0">{{ parent.full_name }}</h6>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="#" onclick="editParent('{{ parent.id }}')">
                                                <i class="fas fa-edit me-2"></i>Edit
                                            </a></li>
                                            <li><a class="dropdown-item text-danger" href="#" onclick="deleteParent('{{ parent.id }}')">
                                                <i class="fas fa-trash me-2"></i>Delete
                                            </a></li>
                                        </ul>
                                    </div>
                                </div>
                                
                                <div class="row g-2 text-sm">
                                    <div class="col-12">
                                        <span class="badge bg-{{ 'primary' if parent.is_primary_contact else 'secondary' }} me-1">
                                            {% if parent.is_primary_contact %}Primary Contact{% else %}Contact{% endif %}
                                        </span>
                                        <span class="badge bg-info">{{ parent.relationship|title }}</span>
                                        {% if parent.is_emergency_contact %}
                                        <span class="badge bg-danger">Emergency Contact</span>
                                        {% endif %}
                                    </div>
                                    
                                    {% if parent.email %}
                                    <div class="col-12">
                                        <i class="fas fa-envelope text-muted me-1"></i>
                                        <a href="mailto:{{ parent.email }}" class="text-decoration-none">{{ parent.email }}</a>
                                    </div>
                                    {% endif %}
                                    
                                    <div class="col-12">
                                        <i class="fas fa-phone text-muted me-1"></i>
                                        <a href="tel:{{ parent.phone }}" class="text-decoration-none">{{ parent.phone }}</a>
                                    </div>
                                    
                                    {% if parent.occupation %}
                                    <div class="col-12">
                                        <i class="fas fa-briefcase text-muted me-1"></i>
                                        {{ parent.occupation }}
                                        {% if parent.workplace %}- {{ parent.workplace }}{% endif %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Enrollments and Academic Progress -->
    <div class="row g-4 mb-4">
        <!-- Current Enrollments -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-book text-info me-2"></i>
                        Current Enrollments
                    </h5>
                    {% if current_user.role in ['superadmin', 'admin', 'coordinator'] %}
                    <a href="{{ url_for('enroll_student_route', id=student.id) }}" class="btn btn-sm btn-primary">
                        <i class="fas fa-plus me-1"></i> New Enrollment
                    </a>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if enrollments %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Subject</th>
                                    <th>Tutor</th>
                                    <th>Schedule</th>
                                    <th>Status</th>
                                    <th>Progress</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for enrollment in enrollments %}
                                <tr>
                                    <td>
                                        <div class="fw-bold">{{ enrollment.subject }}</div>
                                        <small class="text-muted">{{ enrollment.class_type|title }} Classes</small>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-sm me-2">
                                                <i class="fas fa-chalkboard-teacher text-primary"></i>
                                            </div>
                                            <div>
                                                <div class="fw-bold">{{ enrollment.tutor.full_name }}</div>
                                                <small class="text-muted">{{ enrollment.tutor.email }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="small">
                                            <i class="fas fa-calendar me-1"></i>{{ enrollment.sessions_per_week }}x/week<br>
                                            <i class="fas fa-clock me-1"></i>{{ enrollment.session_duration }} min
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ 'success' if enrollment.status == 'active' else 'warning' if enrollment.status == 'pending' else 'secondary' }}">
                                            {{ enrollment.status|title }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="progress" style="height: 8px;">
                                            {% set progress = (enrollment.completed_sessions / enrollment.total_sessions * 100) if enrollment.total_sessions > 0 else 0 %}
                                            <div class="progress-bar bg-success" data-width="{{ progress }}" style="width: 0%"></div>
                                        </div>
                                        <small class="text-muted">
                                            {{ enrollment.completed_sessions }}/{{ enrollment.total_sessions }} sessions
                                        </small>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="{{ url_for('view_enrollment', id=enrollment.id) }}" class="btn btn-outline-primary btn-sm">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            {% if current_user.role in ['superadmin', 'admin', 'coordinator'] %}
                                            <a href="{{ url_for('edit_enrollment', id=enrollment.id) }}" class="btn btn-outline-warning btn-sm">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-book-open fa-3x text-muted mb-3"></i>
                        <h6 class="text-muted">No enrollments found</h6>
                        <p class="text-muted">This student is not enrolled in any subjects yet.</p>
                        {% if current_user.role in ['superadmin', 'admin', 'coordinator'] %}
                        <a href="{{ url_for('enroll_student_route', id=student.id) }}" class="btn btn-primary">
                            <i class="fas fa-plus me-1"></i> Create First Enrollment
                        </a>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Fee Summary -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-dollar-sign text-success me-2"></i>
                        Fee Summary
                    </h5>
                    {% if current_user.role in ['superadmin', 'admin', 'coordinator', 'finance_coordinator'] %}
                    <a href="{{ url_for('student_fees_detail', id=student.id) }}" class="btn btn-sm btn-outline-success">
                        <i class="fas fa-plus me-1"></i> Add Fee
                    </a>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if fees %}
                    <div class="fee-summary mb-3">
                        {% set total_fees = fees|sum(attribute='amount') %}
                        {% set paid_fees = fees|sum(attribute='paid_amount') %}
                        {% set pending_fees = total_fees - paid_fees %}
                        
                        <div class="row g-2 text-center">
                            <div class="col-4">
                                <div class="bg-light p-2 rounded">
                                    <div class="h6 mb-0 text-primary">₹{{ "{:,.0f}".format(total_fees) }}</div>
                                    <small class="text-muted">Total</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="bg-light p-2 rounded">
                                    <div class="h6 mb-0 text-success">₹{{ "{:,.0f}".format(paid_fees) }}</div>
                                    <small class="text-muted">Paid</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="bg-light p-2 rounded">
                                    <div class="h6 mb-0 text-{{ 'warning' if pending_fees > 0 else 'success' }}">₹{{ "{:,.0f}".format(pending_fees) }}</div>
                                    <small class="text-muted">Pending</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="recent-fees">
                        <h6 class="mb-2">Recent Transactions</h6>
                        {% for fee in fees[:3] %}
                        <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                            <div>
                                <div class="fw-bold small">{{ fee.fee_type|title }}</div>
                                <small class="text-muted">Due: {{ fee.due_date.strftime('%b %d') }}</small>
                            </div>
                            <div class="text-end">
                                <div class="fw-bold">₹{{ "{:,.0f}".format(fee.amount) }}</div>
                                <span class="badge bg-{{ 'success' if fee.status == 'paid' else 'warning' if fee.status == 'pending' else 'danger' }} badge-sm">
                                    {{ fee.status|title }}
                                </span>
                            </div>
                        </div>
                        {% endfor %}
                        
                        {% if fees|length > 3 %}
                        <div class="text-center mt-2">
                            <a href="{{ url_for('student_fees_detail', id=student.id) }}" class="btn btn-sm btn-outline-primary">
                                View All Fees
                            </a>
                        </div>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-receipt fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-0">No fee records found</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Additional Information -->
    {% if student.get_custom_fields() %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent border-0">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle text-info me-2"></i>
                        Additional Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        {% for key, value in student.get_custom_fields().items() %}
                        <div class="col-md-6">
                            <div class="info-item">
                                <label class="text-muted small">{{ key|replace('_', ' ')|title }}</label>
                                <div class="fw-bold">{{ value }}</div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<style>
.bg-gradient-info {
    background: linear-gradient(135deg, #17a2b8, #138496) !important;
}

.student-avatar {
    width: 100px;
    height: 100px;
    margin: 0 auto;
    border-radius: 50%;
    overflow: hidden;
    border: 4px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

.student-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.avatar-placeholder {
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
}

.info-item {
    margin-bottom: 1rem;
}

.info-item label {
    display: block;
    margin-bottom: 0.25rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.parent-card {
    background: #f8f9fa;
    transition: all 0.3s ease;
    border: 1px solid #e9ecef !important;
}

.parent-card:hover {
    background: #e9ecef;
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.avatar-sm {
    width: 32px;
    height: 32px;
    background: #f8f9fa;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid #e9ecef;
}

.table td {
    vertical-align: middle;
}

.progress {
    background-color: rgba(0, 0, 0, 0.1);
}

.badge-sm {
    font-size: 0.7rem;
}

.fee-summary .bg-light {
    transition: all 0.3s ease;
}

.fee-summary .bg-light:hover {
    background-color: #e9ecef !important;
    transform: translateY(-2px);
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.card {
    animation: fadeInUp 0.6s ease-out;
}

.card:nth-child(1) { animation-delay: 0.1s; }
.card:nth-child(2) { animation-delay: 0.2s; }
.card:nth-child(3) { animation-delay: 0.3s; }
.card:nth-child(4) { animation-delay: 0.4s; }
</style>

<script>
function editParent(parentId) {
    // Implementation for editing parent
    LMS.showAlert('Edit parent functionality coming soon!', 'info');
}

function deleteParent(parentId) {
    LMS.confirmAction('Are you sure you want to delete this parent/guardian?', function() {
        // Implementation for deleting parent
        LMS.showAlert('Parent deleted successfully!', 'success');
    });
}

function addParentModal() {
    // Implementation for adding new parent
    LMS.showAlert('Add parent functionality coming soon!', 'info');
}
</script>
{% endblock %}