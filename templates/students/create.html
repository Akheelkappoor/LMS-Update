<!-- 1. REPLACE templates/students/create.html with this complete version -->

{% extends "base.html" %}

{% block title %}Add New Student - LMS{% endblock %}

{% block content %}
<div class="page-header">
    <div class="header-content">
        <h1 class="page-title">
            <i class="fas fa-user-graduate"></i>
            Register New Student
        </h1>
    </div>
</div>

<div class="student-registration-container">
    <form method="POST" enctype="multipart/form-data" class="student-form">
        <!-- Personal Information -->
        <div class="form-section">
            <h3><i class="fas fa-user"></i> Personal Information</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label required">First Name</label>
                    <input type="text" name="first_name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label required">Last Name</label>
                    <input type="text" name="last_name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label required">Email</label>
                    <input type="email" name="email" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label required">Phone</label>
                    <input type="tel" name="phone" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Date of Birth</label>
                    <input type="date" name="date_of_birth" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">Gender</label>
                    <select name="gender" class="form-control">
                        <option value="">Select Gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Academic Information -->
        <div class="form-section">
            <h3><i class="fas fa-graduation-cap"></i> Academic Information</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label required">Grade/Class</label>
                    <select name="grade" class="form-control" required>
                        <option value="">Select Grade</option>
                        <option value="1st">1st Grade</option>
                        <option value="2nd">2nd Grade</option>
                        <option value="3rd">3rd Grade</option>
                        <option value="4th">4th Grade</option>
                        <option value="5th">5th Grade</option>
                        <option value="6th">6th Grade</option>
                        <option value="7th">7th Grade</option>
                        <option value="8th">8th Grade</option>
                        <option value="9th">9th Grade</option>
                        <option value="10th">10th Grade</option>
                        <option value="11th">11th Grade</option>
                        <option value="12th">12th Grade</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label required">School Name</label>
                    <input type="text" name="school" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Educational Board</label>
                    <select name="board" class="form-control">
                        <option value="">Select Board</option>
                        <option value="cbse">CBSE</option>
                        <option value="icse">ICSE</option>
                        <option value="state">State Board</option>
                        <option value="igcse">IGCSE</option>
                        <option value="ib">IB</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label required">Department</label>
                    <select name="department_id" class="form-control" required id="studentDepartment">
                        <option value="">Select Department</option>
                        {% for dept in departments %}
                        <option value="{{ dept.id }}">{{ dept.name }} ({{ dept.code }})</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        <!-- Department-Specific Form (Dynamic) -->
        <div id="departmentDynamicForm" class="form-section" style="display: none;">
            <!-- Dynamic form fields will be loaded here -->
        </div>

        <!-- Address Information -->
        <div class="form-section">
            <h3><i class="fas fa-map-marker-alt"></i> Address Information</h3>
            <div class="form-grid">
                <div class="form-group full-width">
                    <label class="form-label">Address Line 1</label>
                    <input type="text" name="address_line1" class="form-control">
                </div>
                <div class="form-group full-width">
                    <label class="form-label">Address Line 2</label>
                    <input type="text" name="address_line2" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">City</label>
                    <input type="text" name="city" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">State</label>
                    <input type="text" name="state" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">Pincode</label>
                    <input type="text" name="pincode" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">Country</label>
                    <input type="text" name="country" class="form-control" value="India">
                </div>
            </div>
        </div>

        <!-- Documents -->
        <div class="form-section">
            <h3><i class="fas fa-file"></i> Documents</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Profile Picture</label>
                    <input type="file" name="profile_picture" class="form-control" accept=".jpg,.jpeg,.png">
                </div>
                <div class="form-group">
                    <label class="form-label">ID Proof</label>
                    <input type="file" name="id_proof" class="form-control" accept=".pdf,.jpg,.jpeg,.png">
                </div>
                <div class="form-group">
                    <label class="form-label">Academic Records</label>
                    <input type="file" name="academic_records" class="form-control" accept=".pdf,.jpg,.jpeg,.png">
                </div>
            </div>
        </div>

        <!-- Submit Button -->
        <div class="form-actions">
            <button type="submit" class="btn btn-primary btn-lg">
                <i class="fas fa-check"></i>
                Register Student
            </button>
            <a href="{{ url_for('students') }}" class="btn btn-secondary">
                Cancel
            </a>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const departmentSelect = document.getElementById('studentDepartment');
    let dynamicFormContainer = document.getElementById('departmentDynamicForm');
    
    if (departmentSelect) {
        departmentSelect.addEventListener('change', function() {
            const departmentId = this.value;
            
            if (departmentId) {
                loadStudentDepartmentForm(departmentId);
            } else {
                clearDynamicForm();
            }
        });
    }
    
    function loadStudentDepartmentForm(departmentId) {
        if (!dynamicFormContainer) return;
        
        // Show loading
        dynamicFormContainer.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
                <p class="mt-2">Loading department form...</p>
            </div>
        `;
        dynamicFormContainer.style.display = 'block';
        
        // Fetch student form for this department
        fetch(`/api/departments/${departmentId}/form?type=student`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('No form assigned');
                }
                return response.json();
            })
            .then(data => {
                renderStudentForm(data.form);
            })
            .catch(error => {
                console.log('No department form found');
                clearDynamicForm();
            });
    }
    
    function renderStudentForm(form) {
        if (!dynamicFormContainer || !form.fields || form.fields.length === 0) {
            clearDynamicForm();
            return;
        }
        
        let fieldsHTML = '';
        
        form.fields.forEach(field => {
            fieldsHTML += generateStudentFieldHTML(field);
        });
        
        dynamicFormContainer.innerHTML = `
            <h3><i class="fas fa-building"></i> ${form.name}</h3>
            ${form.description ? `<p class="text-muted">${form.description}</p>` : ''}
            <div class="form-grid">
                ${fieldsHTML}
            </div>
        `;
        
        dynamicFormContainer.style.display = 'block';
    }
    
    function generateStudentFieldHTML(field) {
        const required = field.required ? 'required' : '';
        const requiredLabel = field.required ? '<span class="text-danger">*</span>' : '';
        
        let inputHTML = '';
        
        switch(field.type) {
            case 'text':
            case 'email':
            case 'tel':
            case 'url':
                inputHTML = `<input type="${field.type}" name="custom_${field.name}" class="form-control" ${required}>`;
                break;
                
            case 'number':
                inputHTML = `<input type="number" name="custom_${field.name}" class="form-control" ${required}>`;
                break;
                
            case 'date':
                inputHTML = `<input type="date" name="custom_${field.name}" class="form-control" ${required}>`;
                break;
                
            case 'textarea':
                inputHTML = `<textarea name="custom_${field.name}" class="form-control" rows="3" ${required}></textarea>`;
                break;
                
            case 'select':
                let options = '<option value="">Select...</option>';
                if (field.options) {
                    field.options.forEach(option => {
                        options += `<option value="${option}">${option}</option>`;
                    });
                }
                inputHTML = `<select name="custom_${field.name}" class="form-control" ${required}>${options}</select>`;
                break;
                
            case 'radio':
                if (field.options) {
                    field.options.forEach(option => {
                        inputHTML += `
                            <div class="form-check">
                                <input type="radio" name="custom_${field.name}" value="${option}" class="form-check-input" ${required}>
                                <label class="form-check-label">${option}</label>
                            </div>
                        `;
                    });
                }
                break;
                
            case 'checkbox':
                if (field.options) {
                    field.options.forEach(option => {
                        inputHTML += `
                            <div class="form-check">
                                <input type="checkbox" name="custom_${field.name}[]" value="${option}" class="form-check-input">
                                <label class="form-check-label">${option}</label>
                            </div>
                        `;
                    });
                }
                break;
                
            case 'file':
                inputHTML = `<input type="file" name="custom_file_${field.name}" class="form-control" ${required}>`;
                break;
        }
        
        return `
            <div class="form-group">
                <label class="form-label">${field.label} ${requiredLabel}</label>
                ${inputHTML}
                ${field.description ? `<small class="form-text text-muted">${field.description}</small>` : ''}
            </div>
        `;
    }
    
    function clearDynamicForm() {
        if (dynamicFormContainer) {
            dynamicFormContainer.style.display = 'none';
            dynamicFormContainer.innerHTML = '';
        }
    }
});
</script>

<style>
.student-registration-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 32px;
}

.student-form {
    background: white;
    border-radius: 16px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    overflow: hidden;
}

.form-section {
    padding: 32px;
    border-bottom: 1px solid #e9ecef;
}

.form-section:last-child {
    border-bottom: none;
}

.form-section h3 {
    color: #333;
    margin-bottom: 24px;
    display: flex;
    align-items: center;
    gap: 12px;
}

.form-section h3 i {
    color: #F1A150;
}

.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
}

.form-group.full-width {
    grid-column: 1 / -1;
}

.form-actions {
    padding: 32px;
    background: #f8f9fa;
    display: flex;
    gap: 16px;
    justify-content: center;
}

.required {
    color: #dc3545;
}
</style>
{% endblock %}