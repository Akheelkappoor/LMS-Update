{% extends "base.html" %}

{% block title %}{{ student.first_name }} {{ student.last_name }} - Enrollments{% endblock %}

{% block content %}
<div class="page-header">
    <div class="header-content">
        <h1 class="page-title">
            <i class="fas fa-user-graduate"></i>
            {{ student.first_name }} {{ student.last_name }} - Subject Enrollments
        </h1>
        <div class="header-actions">
            <a href="{{ url_for('enroll_student_multiple_subjects', student_id=student.id) }}" class="btn btn-primary">
                <i class="fas fa-plus"></i>
                Add More Subjects
            </a>
        </div>
    </div>
</div>

<div class="enrollments-container">
    <!-- Cost Summary -->
    <div class="cost-summary-card">
        <h3><i class="fas fa-calculator"></i> Cost Summary</h3>
        <div class="cost-grid">
            <div class="cost-item">
                <span class="cost-label">Weekly Total:</span>
                <span class="cost-value">₹{{ "%.2f"|format(weekly_cost) }}</span>
            </div>
            <div class="cost-item">
                <span class="cost-label">Monthly Total:</span>
                <span class="cost-value primary">₹{{ "%.2f"|format(monthly_cost) }}</span>
            </div>
            <div class="cost-item">
                <span class="cost-label">Total Subjects:</span>
                <span class="cost-value">{{ enrollments|length }}</span>
            </div>
        </div>
    </div>

    <!-- Enrollments List -->
    {% if enrollments %}
    <div class="enrollments-grid">
        {% for enrollment in enrollments %}
        <div class="enrollment-card">
            <div class="enrollment-header">
                <div class="subject-info">
                    <h4>{{ enrollment.subject }}</h4>
                    <span class="enrollment-status status-{{ enrollment.status }}">{{ enrollment.status|title }}</span>
                </div>
                <div class="enrollment-actions">
                    <button class="btn btn-sm btn-outline-primary" onclick="scheduleClass('{{ enrollment.id }}')">
                        <i class="fas fa-calendar-plus"></i>
                        Schedule Class
                    </button>
                </div>
            </div>
            
            <div class="enrollment-details">
                <div class="detail-row">
                    <i class="fas fa-chalkboard-teacher"></i>
                    <span><strong>Tutor:</strong> {{ enrollment.tutor.full_name if enrollment.tutor else 'Not Assigned' }}</span>
                </div>
                <div class="detail-row">
                    <i class="fas fa-rupee-sign"></i>
                    <span><strong>Rate:</strong> ₹{{ enrollment.hourly_rate }}/hour</span>
                </div>
                <div class="detail-row">
                    <i class="fas fa-calendar-week"></i>
                    <span><strong>Frequency:</strong> {{ enrollment.classes_per_week }} classes/week</span>
                </div>
                <div class="detail-row">
                    <i class="fas fa-clock"></i>
                    <span><strong>Schedule:</strong> {{ enrollment.preferred_schedule|title if enrollment.preferred_schedule else 'Flexible' }}</span>
                </div>
                <div class="detail-row">
                    <i class="fas fa-calendar"></i>
                    <span><strong>Enrolled:</strong> {{ enrollment.enrollment_date.strftime('%B %d, %Y') if enrollment.enrollment_date else 'Unknown' }}</span>
                </div>
            </div>
            
            <div class="progress-section">
                <div class="progress-header">
                    <span class="progress-label">Progress</span>
                    <span class="progress-stats">{{ enrollment.completed_sessions }}/{{ enrollment.total_sessions }} classes</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: {{ enrollment.get_completion_percentage() }} %"></div>
                </div>
                <div class="progress-details">
                    <span class="progress-percentage">{{ "%.1f"|format(enrollment.get_completion_percentage()) }}% Complete</span>
                    <span class="progress-hours">{{ enrollment.total_hours }} hours total</span>
                </div>
            </div>
            
            <div class="cost-breakdown">
                <div class="cost-row">
                    <span>Weekly Cost:</span>
                    <span class="cost">₹{{ "%.2f"|format(enrollment.get_weekly_cost()) }}</span>
                </div>
                <div class="cost-row">
                    <span>Monthly Cost:</span>
                    <span class="cost">₹{{ "%.2f"|format(enrollment.get_monthly_cost()) }}</span>
                </div>
            </div>
            
            <div class="enrollment-footer">
                <button class="btn btn-sm btn-outline-warning" onclick="pauseEnrollment('{{ enrollment.id }}')">
                    <i class="fas fa-pause"></i>
                    Pause
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="editEnrollment('{{ enrollment.id }}')">
                    <i class="fas fa-edit"></i>
                    Edit
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="cancelEnrollment('{{ enrollment.id }}')">
                    <i class="fas fa-times"></i>
                    Cancel
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-icon">
            <i class="fas fa-book-open"></i>
        </div>
        <h3>No Subject Enrollments</h3>
        <p>This student is not enrolled in any subjects yet.</p>
        <a href="{{ url_for('enroll_student_multiple_subjects', student_id=student.id) }}" class="btn btn-primary btn-lg">
            <i class="fas fa-plus"></i>
            Enroll in Subjects
        </a>
    </div>
    {% endif %}
</div>

<script>
function scheduleClass(enrollmentId) {
    // Redirect to schedule page with pre-filled enrollment
    window.location.href = `/schedule?enrollment_id=${enrollmentId}`;
}

function pauseEnrollment(enrollmentId) {
    if (confirm('Are you sure you want to pause this enrollment?')) {
        fetch(`/api/enrollments/${enrollmentId}/pause`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        });
    }
}

function editEnrollment(enrollmentId) {
    // Implementation for editing enrollment
    alert('Edit enrollment feature coming soon...');
}

function cancelEnrollment(enrollmentId) {
    const reason = prompt('Please provide a reason for cancellation:');
    if (reason) {
        fetch(`/api/enrollments/${enrollmentId}/cancel`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ reason: reason })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        });
    }
}
</script>

<style>
.enrollments-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 32px;
}

.cost-summary-card {
    background: white;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 32px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.cost-summary-card h3 {
    color: #333;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 12px;
}

.cost-summary-card h3 i {
    color: #F1A150;
}

.cost-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
}

.cost-item {
    display: flex;
    justify-content: between;
    align-items: center;
    padding: 16px;
    background: #f8f9fa;
    border-radius: 8px;
}

.cost-label {
    font-weight: 600;
    color: #666;
}

.cost-value {
    font-weight: 700;
    font-size: 18px;
    color: #333;
}

.cost-value.primary {
    color: #F1A150;
}

.enrollments-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 24px;
}

.enrollment-card {
    background: white;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-left: 4px solid #F1A150;
}

.enrollment-header {
    display: flex;
    justify-content: between;
    align-items: start;
    margin-bottom: 20px;
}

.subject-info h4 {
    margin: 0 0 8px 0;
    color: #333;
}

.enrollment-status {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
}

.status-active {
    background: #e8f5e8;
    color: #2e7d32;
}

.status-paused {
    background: #fff3e0;
    color: #f57c00;
}

.status-cancelled {
    background: #ffebee;
    color: #c62828;
}

.enrollment-details {
    margin-bottom: 20px;
}

.detail-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
    color: #666;
}

.detail-row i {
    width: 16px;
    color: #F1A150;
}

.progress-section {
    margin-bottom: 20px;
    padding: 16px;
    background: #f8f9fa;
    border-radius: 8px;
}

.progress-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 8px;
}

.progress-label {
    font-weight: 600;
    color: #333;
}

.progress-stats {
    font-size: 14px;
    color: #666;
}

.progress-bar {
    width: 100%;
    height: 8px;
    background: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 8px;
}

.progress-fill {
    height: 100%;
    background: #28a745;
    transition: width 0.3s ease;
}

.progress-details {
    display: flex;
    justify-content: between;
    font-size: 12px;
    color: #666;
}

.cost-breakdown {
    margin-bottom: 20px;
    padding: 16px;
    background: #f8f9fa;
    border-radius: 8px;
}

.cost-row {
    display: flex;
    justify-content: between;
    margin-bottom: 8px;
}

.cost-row:last-child {
    margin-bottom: 0;
}

.cost {
    font-weight: 600;
    color: #F1A150;
}

.enrollment-footer {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.empty-state {
    text-align: center;
    padding: 80px 32px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.empty-icon {
    font-size: 64px;
    color: #dee2e6;
    margin-bottom: 24px;
}

.empty-state h3 {
    color: #333;
    margin-bottom: 16px;
}

.empty-state p {
    color: #666;
    margin-bottom: 32px;
}

@media (max-width: 768px) {
    .enrollments-grid {
        grid-template-columns: 1fr;
    }
    
    .cost-grid {
        grid-template-columns: 1fr;
    }
    
    .enrollment-header {
        flex-direction: column;
        gap: 12px;
    }
    
    .enrollment-footer {
        justify-content: center;
    }
}
</style>
{% endblock %}