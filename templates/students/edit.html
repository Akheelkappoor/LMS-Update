{% extends "base.html" %}

{% block title %}Edit {{ student.full_name }} - LMS{% endblock %}

{% block content %}
<div class="page-header">
    <div class="header-content">
        <h1 class="page-title">
            <i class="fas fa-user-edit"></i>
            Edit Student
        </h1>
        <div class="header-actions">
            <a href="{{ url_for('view_student', id=student.id) }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i>
                Back to Student
            </a>
        </div>
    </div>
</div>

<form method="POST" id="editStudentForm" enctype="multipart/form-data">
    <div class="form-container">
        <!-- Basic Information -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-user"></i>
                    Basic Information
                </h3>
            </div>
            <div class="card-body">
                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label class="form-label required">First Name</label>
                        <input type="text" name="first_name" class="form-control" value="{{ student.first_name }}" required>
                    </div>
                    
                    <div class="form-group col-md-6">
                        <label class="form-label required">Last Name</label>
                        <input type="text" name="last_name" class="form-control" value="{{ student.last_name }}" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group col-md-4">
                        <label class="form-label">Date of Birth</label>
                        <input type="date" name="date_of_birth" class="form-control" 
                               value="{{ student.date_of_birth.strftime('%Y-%m-%d') if student.date_of_birth else '' }}"
                               onchange="calculateAge()">
                    </div>
                    
                    <div class="form-group col-md-4">
                        <label class="form-label">Gender</label>
                        <select name="gender" class="form-control">
                            <option value="">Select Gender</option>
                            <option value="male" {% if student.gender == 'male' %}selected{% endif %}>Male</option>
                            <option value="female" {% if student.gender == 'female' %}selected{% endif %}>Female</option>
                            <option value="other" {% if student.gender == 'other' %}selected{% endif %}>Other</option>
                        </select>
                    </div>
                    
                    <div class="form-group col-md-4">
                        <label class="form-label">Age</label>
                        <input type="number" name="age" class="form-control" id="ageField" value="{{ student.age or '' }}" readonly>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group col-md-12">
                        <label class="form-label">Profile Picture</label>
                        {% if student.profile_picture %}
                        <div class="current-image">
                            <img src="{{ url_for('static', filename='uploads/' + student.profile_picture) }}" 
                                 alt="Current Profile" style="max-width: 150px; margin-bottom: 10px;">
                            <p class="text-muted">Current profile picture</p>
                        </div>
                        {% endif %}
                        <div class="file-upload-area" onclick="document.getElementById('profilePicture').click()">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Click to upload new profile picture</p>
                            <input type="file" id="profilePicture" name="profile_picture" accept="image/*" style="display: none;" onchange="previewImage(this)">
                        </div>
                        <div id="imagePreview" style="display: none;">
                            <img id="previewImg" src="" alt="Preview" style="max-width: 150px; margin-top: 10px;">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Academic Information -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-graduation-cap"></i>
                    Academic Information
                </h3>
            </div>
            <div class="card-body">
                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label class="form-label required">Grade</label>
                        <select name="grade" class="form-control" required>
                            <option value="">Select Grade</option>
                            {% for grade in grades %}
                            <option value="{{ grade }}" {% if student.grade == grade %}selected{% endif %}>{{ grade }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group col-md-6">
                        <label class="form-label required">Board</label>
                        <select name="board" class="form-control" required>
                            <option value="">Select Board</option>
                            {% for board in boards %}
                            <option value="{{ board }}" {% if student.board == board %}selected{% endif %}>{{ board }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group col-md-8">
                        <label class="form-label">School Name</label>
                        <input type="text" name="school_name" class="form-control" 
                               value="{{ student.school_name or '' }}" placeholder="Enter school name">
                    </div>
                    
                    <div class="form-group col-md-4">
                        <label class="form-label">Pincode</label>
                        <input type="text" name="pincode" class="form-control" 
                               value="{{ student.pincode or '' }}" pattern="[0-9]{6}" title="6 digit pincode">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label class="form-label">Academic Year</label>
                        <input type="text" name="academic_year" class="form-control" 
                               value="{{ student.academic_year or '' }}" placeholder="e.g., 2024-25">
                    </div>
                    
                    <div class="form-group col-md-6">
                        <label class="form-label">Department</label>
                        <select name="department_id" class="form-control">
                            <option value="">Select Department</option>
                            {% for dept in departments %}
                            <option value="{{ dept.id }}" {% if student.department_id == dept.id %}selected{% endif %}>{{ dept.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group col-md-12">
                        <label class="form-label">Learning Goals</label>
                        <textarea name="learning_goals" class="form-control" rows="3" 
                                  placeholder="What does the student want to achieve?">{{ student.learning_goals or '' }}</textarea>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Contact Information -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-address-book"></i>
                    Contact Information
                </h3>
            </div>
            <div class="card-body">
                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label class="form-label">Email Address</label>
                        <input type="email" name="email" class="form-control" 
                               value="{{ student.email or '' }}" placeholder="student@example.com">
                    </div>
                    
                    <div class="form-group col-md-6">
                        <label class="form-label">Phone Number</label>
                        <input type="tel" name="phone" class="form-control" 
                               value="{{ student.phone or '' }}" pattern="[0-9]{10}" title="10 digit phone number">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group col-md-12">
                        <label class="form-label">Address</label>
                        <textarea name="address" class="form-control" rows="3" 
                                  placeholder="Full address">{{ student.address or '' }}</textarea>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group col-md-4">
                        <label class="form-label">City</label>
                        <input type="text" name="city" class="form-control" value="{{ student.city or '' }}">
                    </div>
                    
                    <div class="form-group col-md-4">
                        <label class="form-label">State</label>
                        <input type="text" name="state" class="form-control" value="{{ student.state or '' }}">
                    </div>
                    
                    <div class="form-group col-md-4">
                        <label class="form-label">Emergency Contact</label>
                        <input type="tel" name="emergency_contact" class="form-control" 
                               value="{{ student.emergency_contact or '' }}" pattern="[0-9]{10}" title="10 digit phone number">
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Form Actions -->
        <div class="form-actions">
            <div class="action-buttons">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="fas fa-save"></i>
                    Update Student
                </button>
                
                <a href="{{ url_for('view_student', id=student.id) }}" class="btn btn-secondary">
                    <i class="fas fa-times"></i>
                    Cancel
                </a>
                
                <button type="button" class="btn btn-danger" onclick="confirmDelete('{{ student.id }}')">
                    <i class="fas fa-trash"></i>
                    Delete Student
                </button>
            </div>
        </div>
    </div>
</form>

<style>
/* Form Container */
.form-container {
    max-width: 900px;
    margin: 0 auto;
}

/* Card Styling */
.card {
    background: white;
    border: none;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    margin-bottom: 20px;
}

.card-header {
    background: #f8f9fa;
    border-bottom: 1px solid #e9ecef;
    padding: 20px;
    border-radius: 12px 12px 0 0;
}

.card-title {
    font-size: 18px;
    font-weight: 600;
    margin: 0;
    color: #495057;
}

.card-title i {
    color: #F1A150;
    margin-right: 8px;
}

.card-body {
    padding: 25px;
}

/* Form Elements */
.form-row {
    display: flex;
    flex-wrap: wrap;
    margin: 0 -10px;
}

.form-group {
    padding: 0 10px;
    margin-bottom: 20px;
}

.form-label {
    font-weight: 500;
    color: #495057;
    margin-bottom: 6px;
    display: block;
}

.form-label.required::after {
    content: '*';
    color: #dc3545;
    margin-left: 4px;
}

.form-control {
    width: 100%;
    padding: 10px 12px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 14px;
    transition: border-color 0.3s ease;
}

.form-control:focus {
    outline: none;
    border-color: #F1A150;
    box-shadow: 0 0 0 3px rgba(241, 161, 80, 0.1);
}

/* File Upload */
.file-upload-area {
    border: 2px dashed #e9ecef;
    border-radius: 8px;
    padding: 30px 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.file-upload-area:hover {
    border-color: #F1A150;
    background: rgba(241, 161, 80, 0.05);
}

.file-upload-area i {
    font-size: 24px;
    color: #6c757d;
    margin-bottom: 8px;
}

.current-image img {
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

/* Form Actions */
.form-actions {
    background: #f8f9fa;
    padding: 25px;
    border-radius: 12px;
    margin-top: 20px;
}

.action-buttons {
    display: flex;
    gap: 15px;
    justify-content: center;
}

.btn {
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    font-weight: 500;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn i {
    margin-right: 8px;
}

.btn-primary {
    background: #F1A150;
    color: white;
}

.btn-primary:hover {
    background: #C86706;
    transform: translateY(-2px);
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #545b62;
}

.btn-danger {
    background: #dc3545;
    color: white;
}

.btn-danger:hover {
    background: #c82333;
    transform: translateY(-2px);
}

.btn-lg {
    padding: 15px 30px;
    font-size: 16px;
}

/* Responsive */
@media (max-width: 768px) {
    .form-row {
        flex-direction: column;
    }
    
    .form-group {
        width: 100%;
    }
    
    .action-buttons {
        flex-direction: column;
    }
}
</style>

<script>
function calculateAge() {
    const birthDate = new Date(document.querySelector('[name="date_of_birth"]').value);
    const today = new Date();
    let age = today.getFullYear() - birthDate.getFullYear();
    const monthDiff = today.getMonth() - birthDate.getMonth();
    
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
        age--;
    }
    
    document.getElementById('ageField').value = age >= 0 ? age : '';
}

function previewImage(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('previewImg').src = e.target.result;
            document.getElementById('imagePreview').style.display = 'block';
        };
        reader.readAsDataURL(input.files[0]);
    }
}

function confirmDelete(studentId) {
    if (confirm('Are you sure you want to delete this student? This action cannot be undone.')) {
        fetch(`/students/${studentId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrf_token]')?.value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                window.location.href = '/students';
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            alert('Error deleting student: ' + error.message);
        });
    }
}

// Form validation
document.getElementById('editStudentForm').addEventListener('submit', function(e) {
    const requiredFields = document.querySelectorAll('[required]');
    
    for (let field of requiredFields) {
        if (!field.value.trim()) {
            field.focus();
            alert('Please fill in all required fields.');
            e.preventDefault();
            return false;
        }
    }
});
</script>

{% endblock %}