{% extends "base.html" %}

{% block title %}Create User - LMS{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <div class="header-content">
            <h1 class="page-title">
                <i class="fas fa-user-plus"></i>
                Create New User
            </h1>
            <div class="header-actions">
                <a href="{{ url_for('users') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i>
                    Back to Users
                </a>
            </div>
        </div>
    </div>

    <div class="create-user-container">
        <form method="POST" id="createUserForm" enctype="multipart/form-data">
            <!-- Basic Information Card -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-user"></i>
                        Basic Information
                    </h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label required">Full Name</label>
                                <input type="text" name="full_name" class="form-control" required 
                                       placeholder="Enter full name" autofocus>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label required">Username</label>
                                <input type="text" name="username" class="form-control" required 
                                       placeholder="Enter username" pattern="[a-zA-Z0-9_]{3,20}">
                                <small class="form-text">3-20 characters, letters, numbers, underscore only</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label required">Email</label>
                                <input type="email" name="email" class="form-control" required 
                                       placeholder="Enter email address">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Phone</label>
                                <input type="tel" name="phone" class="form-control" 
                                       placeholder="Enter phone number">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label required">Password</label>
                                <div class="password-input">
                                    <input type="password" name="password" class="form-control" required 
                                           placeholder="Enter password" minlength="6">
                                    <button type="button" class="password-toggle" onclick="togglePassword()">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <small class="form-text">Minimum 6 characters</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label required">Role</label>
                                <select name="role" class="form-control" required id="userRole">
                                    <option value="">Select Role</option>
                                    <option value="tutor">Tutor</option>
                                    <option value="coordinator">Coordinator</option>
                                    <option value="finance_coordinator">Finance Coordinator</option>
                                    {% if current_user.role == 'superadmin' %}
                                    <option value="admin">Admin</option>
                                    {% endif %}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Department Assignment Card -->
            <div class="card" id="departmentCard">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-building"></i>
                        Department Assignment
                    </h3>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label">Department</label>
                        <select name="department_id" class="form-control" id="userDepartment">
                            <option value="">Select Department</option>
                            {% for dept in departments %}
                            <option value="{{ dept.id }}">{{ dept.name }} ({{ dept.code }})</option>
                            {% endfor %}
                        </select>
                        <small class="form-text">Required for Tutors and Coordinators</small>
                    </div>
                </div>
            </div>

            <!-- Financial Information Card (for Tutors) -->
            <div class="card" id="financeCard" style="display: none;">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-money-bill-wave"></i>
                        Financial Information
                    </h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Hourly Rate (â‚¹)</label>
                                <input type="number" name="hourly_rate" class="form-control" 
                                       placeholder="0" min="0" step="0.01">
                                <small class="form-text">Leave empty if not applicable</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Payment Method</label>
                                <select name="payment_method" class="form-control">
                                    <option value="">Select Method</option>
                                    <option value="bank_transfer">Bank Transfer</option>
                                    <option value="cash">Cash</option>
                                    <option value="cheque">Cheque</option>
                                    <option value="upi">UPI</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Bank Name</label>
                                <input type="text" name="bank_name" class="form-control" 
                                       placeholder="Enter bank name">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Account Number</label>
                                <input type="text" name="account_number" class="form-control" 
                                       placeholder="Enter account number">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">IFSC Code</label>
                                <input type="text" name="ifsc_code" class="form-control" 
                                       placeholder="Enter IFSC code">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Tax ID/PAN</label>
                                <input type="text" name="tax_id" class="form-control" 
                                       placeholder="Enter PAN number">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Permissions Card -->
            <div class="card" id="permissionsCard" style="display: none;">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-key"></i>
                        Custom Permissions
                    </h3>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">
                        Select additional permissions for this user. Default role permissions will be applied automatically.
                    </p>
                    
                    <div class="permissions-grid">
                        <div class="permission-group">
                            <h5>Class Management</h5>
                            <div class="form-check">
                                <input type="checkbox" name="permissions" value="approve_demo_requests" class="form-check-input">
                                <label class="form-check-label">Approve Demo Requests</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" name="permissions" value="schedule_demos" class="form-check-input">
                                <label class="form-check-label">Schedule Demo Classes</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" name="permissions" value="quality_assurance" class="form-check-input">
                                <label class="form-check-label">Quality Assurance</label>
                            </div>
                        </div>
                        
                        <div class="permission-group">
                            <h5>Payment & Finance</h5>
                            <div class="form-check">
                                <input type="checkbox" name="permissions" value="payment_approval" class="form-check-input">
                                <label class="form-check-label">Payment Approval</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" name="permissions" value="late_arrival_management" class="form-check-input">
                                <label class="form-check-label">Late Arrival Management</label>
                            </div>
                        </div>
                        
                        <div class="permission-group">
                            <h5>Communication</h5>
                            <div class="form-check">
                                <input type="checkbox" name="permissions" value="email_reminders" class="form-check-input">
                                <label class="form-check-label">Send Email Reminders</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" name="permissions" value="escalation_management" class="form-check-input">
                                <label class="form-check-label">Escalation Management</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" name="permissions" value="bulk_communications" class="form-check-input">
                                <label class="form-check-label">Bulk Communications</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="form-actions">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="fas fa-save"></i>
                    Create User
                </button>
                <a href="{{ url_for('users') }}" class="btn btn-secondary btn-lg">
                    <i class="fas fa-times"></i>
                    Cancel
                </a>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const roleSelect = document.getElementById('userRole');
    const departmentCard = document.getElementById('departmentCard');
    const financeCard = document.getElementById('financeCard');
    const permissionsCard = document.getElementById('permissionsCard');
    const departmentSelect = document.getElementById('userDepartment');
    
    roleSelect.addEventListener('change', function() {
        const role = this.value;
        
        // Show/hide department card
        if (role === 'tutor' || role === 'coordinator') {
            departmentCard.style.display = 'block';
            departmentSelect.required = true;
        } else {
            departmentCard.style.display = 'none';
            departmentSelect.required = false;
        }
        
        // Show/hide finance card
        if (role === 'tutor') {
            financeCard.style.display = 'block';
        } else {
            financeCard.style.display = 'none';
        }
        
        // Show/hide permissions card
        if (role && role !== 'superadmin') {
            permissionsCard.style.display = 'block';
        } else {
            permissionsCard.style.display = 'none';
        }
    });
});

function togglePassword() {
    const passwordInput = document.querySelector('input[name="password"]');
    const toggleIcon = document.querySelector('.password-toggle i');
    
    if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        toggleIcon.className = 'fas fa-eye-slash';
    } else {
        passwordInput.type = 'password';
        toggleIcon.className = 'fas fa-eye';
    }
}

// Dynamic Form Loading for Department-Specific Forms
document.addEventListener('DOMContentLoaded', function() {
    const departmentSelect = document.getElementById('userDepartment');
    const roleSelect = document.getElementById('userRole');
    let dynamicFormContainer = null;
    
    // Create container for dynamic form
    createDynamicFormContainer();
    
    if (departmentSelect) {
        departmentSelect.addEventListener('change', function() {
            const departmentId = this.value;
            const currentRole = roleSelect ? roleSelect.value : 'user';
            
            if (departmentId) {
                loadDepartmentForm(departmentId, currentRole);
            } else {
                clearDynamicForm();
            }
        });
    }
    
    if (roleSelect) {
        roleSelect.addEventListener('change', function() {
            const departmentId = departmentSelect ? departmentSelect.value : null;
            const currentRole = this.value;
            
            if (departmentId) {
                loadDepartmentForm(departmentId, currentRole);
            }
        });
    }
    
    function createDynamicFormContainer() {
        // Find insertion point after department card
        const departmentCard = document.getElementById('departmentCard');
        if (departmentCard) {
            dynamicFormContainer = document.createElement('div');
            dynamicFormContainer.id = 'departmentDynamicForm';
            dynamicFormContainer.className = 'card mt-4';
            dynamicFormContainer.style.display = 'none';
            
            // Insert after department card
            departmentCard.insertAdjacentElement('afterend', dynamicFormContainer);
        }
    }
    
    function loadDepartmentForm(departmentId, role) {
        if (!dynamicFormContainer) {
            console.error('Dynamic form container not found');
            return;
        }
        
        // Show loading
        dynamicFormContainer.innerHTML = `
            <div class="card-body text-center">
                <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
                <p class="mt-2">Loading department form...</p>
            </div>
        `;
        dynamicFormContainer.style.display = 'block';
        
        // Determine form type
        const formType = (role === 'tutor') ? 'tutor' : 'user';
        
        // Fetch form
        fetch(`/api/departments/${departmentId}/form?type=${formType}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('No form assigned');
                }
                return response.json();
            })
            .then(data => {
                renderDepartmentForm(data.form);
            })
            .catch(error => {
                console.log('No department form found');
                clearDynamicForm();
            });
    }
    
    function renderDepartmentForm(form) {
        if (!dynamicFormContainer || !form.fields || form.fields.length === 0) {
            clearDynamicForm();
            return;
        }
        
        let fieldsHTML = '';
        
        form.fields.forEach(field => {
            fieldsHTML += generateFieldHTML(field);
        });
        
        dynamicFormContainer.innerHTML = `
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-form"></i>
                    ${form.name}
                </h3>
                ${form.description ? `<p class="card-description">${form.description}</p>` : ''}
            </div>
            <div class="card-body">
                <div class="row">
                    ${fieldsHTML}
                </div>
            </div>
        `;
        
        dynamicFormContainer.style.display = 'block';
    }
    
    function generateFieldHTML(field) {
        const required = field.required ? 'required' : '';
        const requiredLabel = field.required ? '<span class="text-danger">*</span>' : '';
        
        let inputHTML = '';
        
        switch(field.type) {
            case 'text':
            case 'email':
            case 'tel':
            case 'url':
                inputHTML = `<input type="${field.type}" name="custom_${field.name}" class="form-control" ${required}>`;
                break;
                
            case 'number':
                inputHTML = `<input type="number" name="custom_${field.name}" class="form-control" ${required}>`;
                break;
                
            case 'date':
                inputHTML = `<input type="date" name="custom_${field.name}" class="form-control" ${required}>`;
                break;
                
            case 'textarea':
                inputHTML = `<textarea name="custom_${field.name}" class="form-control" rows="3" ${required}></textarea>`;
                break;
                
            case 'select':
                let options = '<option value="">Select...</option>';
                if (field.options) {
                    field.options.forEach(option => {
                        options += `<option value="${option}">${option}</option>`;
                    });
                }
                inputHTML = `<select name="custom_${field.name}" class="form-control" ${required}>${options}</select>`;
                break;
                
            case 'radio':
                if (field.options) {
                    field.options.forEach(option => {
                        inputHTML += `
                            <div class="form-check">
                                <input type="radio" name="custom_${field.name}" value="${option}" class="form-check-input" ${required}>
                                <label class="form-check-label">${option}</label>
                            </div>
                        `;
                    });
                }
                break;
                
            case 'checkbox':
                if (field.options) {
                    field.options.forEach(option => {
                        inputHTML += `
                            <div class="form-check">
                                <input type="checkbox" name="custom_${field.name}[]" value="${option}" class="form-check-input">
                                <label class="form-check-label">${option}</label>
                            </div>
                        `;
                    });
                }
                break;
                
            case 'file':
                inputHTML = `<input type="file" name="custom_file_${field.name}" class="form-control" ${required}>`;
                break;
        }
        
        return `
            <div class="col-md-6 mb-3">
                <div class="form-group">
                    <label class="form-label">${field.label} ${requiredLabel}</label>
                    ${inputHTML}
                    ${field.description ? `<small class="form-text text-muted">${field.description}</small>` : ''}
                </div>
            </div>
        `;
    }
    
    function clearDynamicForm() {
        if (dynamicFormContainer) {
            dynamicFormContainer.style.display = 'none';
            dynamicFormContainer.innerHTML = '';
        }
    }
});
</script>

<style>
.create-user-container {
    display: flex;
    flex-direction: column;
    gap: 24px;
    max-width: 1000px;
    margin: 0 auto;
}

.card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    overflow: hidden;
}

.card-header {
    background: #f8f9fa;
    padding: 20px 24px;
    border-bottom: 1px solid #e9ecef;
}

.card-title {
    font-size: 18px;
    font-weight: 600;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 8px;
}

.card-body {
    padding: 24px;
}

.password-input {
    position: relative;
}

.password-toggle {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: #6c757d;
    cursor: pointer;
}

.permissions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 24px;
}

.permission-group h5 {
    color: var(--primary-color);
    margin-bottom: 12px;
    font-size: 14px;
    font-weight: 600;
}

.form-check {
    margin-bottom: 8px;
}

.form-actions {
    display: flex;
    gap: 16px;
    justify-content: flex-end;
    padding: 24px 0;
}
</style>
{% endblock %}