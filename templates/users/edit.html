{% extends "base.html" %}

{% block title %}Edit User - {{ user.full_name or user.username }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 bg-gradient-warning text-dark">
                <div class="card-body p-4">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h1 class="h3 mb-2">
                                <i class="fas fa-user-edit me-3"></i>
                                Edit User: {{ user.full_name or user.username }}
                            </h1>
                            <p class="mb-0 opacity-75">Update user information, role, and permissions</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="btn-group">
                                <a href="{{ url_for('view_user', id=user.id) }}" class="btn btn-dark btn-sm">
                                    <i class="fas fa-eye me-1"></i>
                                    View Profile
                                </a>
                                <a href="{{ url_for('users') }}" class="btn btn-outline-dark btn-sm">
                                    <i class="fas fa-arrow-left me-1"></i>
                                    Back to Users
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <form method="POST" enctype="multipart/form-data" class="needs-validation" novalidate>
        <div class="row g-4">
            <!-- Basic Information -->
            <div class="col-lg-8">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-transparent border-0">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-user text-primary me-2"></i>
                            Basic Information
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label required">Full Name</label>
                                <input type="text" name="full_name" class="form-control" required 
                                       value="{{ user.full_name or '' }}" placeholder="Enter full name">
                                <div class="invalid-feedback">Please provide a valid full name.</div>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label required">Username</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-at"></i></span>
                                    <input type="text" name="username" class="form-control" required 
                                           value="{{ user.username }}" placeholder="Enter username">
                                    <div class="invalid-feedback">Please choose a unique username.</div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label required">Email Address</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                                    <input type="email" name="email" class="form-control" required 
                                           value="{{ user.email }}" placeholder="Enter email address">
                                    <div class="invalid-feedback">Please provide a valid email address.</div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">Phone Number</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-phone"></i></span>
                                    <input type="tel" name="phone" class="form-control" 
                                           value="{{ user.phone or '' }}" placeholder="Enter phone number">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Role & Department -->
                <div class="card border-0 shadow-sm mt-4">
                    <div class="card-header bg-transparent border-0">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-shield-alt text-warning me-2"></i>
                            Role & Access
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label required">User Role</label>
                                <select name="role" class="form-select" required id="userRole">
                                    {% if current_user.role == 'superadmin' %}
                                    <option value="admin" {% if user.role == 'admin' %}selected{% endif %}>Administrator</option>
                                    {% endif %}
                                    <option value="coordinator" {% if user.role == 'coordinator' %}selected{% endif %}>Coordinator</option>
                                    <option value="tutor" {% if user.role == 'tutor' %}selected{% endif %}>Tutor</option>
                                    <option value="finance_coordinator" {% if user.role == 'finance_coordinator' %}selected{% endif %}>Finance Coordinator</option>
                                </select>
                                <div class="invalid-feedback">Please select a user role.</div>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">Department</label>
                                <select name="department_id" class="form-select" id="userDepartment">
                                    <option value="">No Department</option>
                                    {% for dept in departments %}
                                    <option value="{{ dept.id }}" {% if user.department_id == dept.id %}selected{% endif %}>
                                        {{ dept.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="row g-3 mt-2">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="is_active" 
                                           id="isActive" {% if user.is_active %}checked{% endif %}>
                                    <label class="form-check-label" for="isActive">
                                        Account is active
                                    </label>
                                </div>
                            </div>
                            
                            {% if user.role != 'superadmin' %}
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="is_approved" 
                                           id="isApproved" {% if user.is_approved %}checked{% endif %}>
                                    <label class="form-check-label" for="isApproved">
                                        Account is approved
                                    </label>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Finance Information (for Tutors) -->
                <div class="card border-0 shadow-sm mt-4 {% if user.role != 'tutor' %}d-none{% endif %}" id="financeSection">
                    <div class="card-header bg-transparent border-0">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-dollar-sign text-success me-2"></i>
                            Finance Information
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Hourly Rate (₹)</label>
                                <div class="input-group">
                                    <span class="input-group-text">₹</span>
                                    <input type="number" name="hourly_rate" class="form-control" 
                                           value="{{ user.hourly_rate or '' }}" placeholder="500" min="0" step="50">
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <label class="form-label">Payment Method</label>
                                <select name="payment_method" class="form-select">
                                    <option value="">Select Method</option>
                                    <option value="bank_transfer" {% if user.payment_method == 'bank_transfer' %}selected{% endif %}>Bank Transfer</option>
                                    <option value="cash" {% if user.payment_method == 'cash' %}selected{% endif %}>Cash</option>
                                    <option value="cheque" {% if user.payment_method == 'cheque' %}selected{% endif %}>Cheque</option>
                                </select>
                            </div>
                            
                            <div class="col-md-4">
                                <label class="form-label">Tax ID / PAN</label>
                                <input type="text" name="tax_id" class="form-control" 
                                       value="{{ user.tax_id or '' }}" placeholder="Enter PAN or Tax ID">
                            </div>

                            {% set bank_details = user.get_bank_details() %}
                            <div class="col-md-6">
                                <label class="form-label">Bank Name</label>
                                <input type="text" name="bank_name" class="form-control" 
                                       value="{{ bank_details.bank_name or '' }}" placeholder="Enter bank name">
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">Account Number</label>
                                <input type="text" name="account_number" class="form-control" 
                                       value="{{ bank_details.account_number or '' }}" placeholder="Enter account number">
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">IFSC Code</label>
                                <input type="text" name="ifsc_code" class="form-control" 
                                       value="{{ bank_details.ifsc_code or '' }}" placeholder="Enter IFSC code">
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">Account Holder Name</label>
                                <input type="text" name="account_holder_name" class="form-control" 
                                       value="{{ bank_details.account_holder_name or '' }}" placeholder="Enter account holder name">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Profile Picture & Actions -->
            <div class="col-lg-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-transparent border-0">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-camera text-info me-2"></i>
                            Profile Picture
                        </h5>
                    </div>
                    <div class="card-body text-center">
                        <div class="profile-upload mb-3">
                            <div class="avatar-preview bg-light rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center" 
                                 style="width: 120px; height: 120px; border: 2px dashed #dee2e6;">
                                {% if user.profile_picture %}
                                    <img src="{{ url_for('static', filename='uploads/' + user.profile_picture) }}" 
                                         class="rounded-circle" width="120" height="120" id="avatarPreview">
                                {% else %}
                                    <i class="fas fa-user fa-3x text-muted" id="avatarPreview"></i>
                                {% endif %}
                            </div>
                            <input type="file" name="profile_picture" class="form-control" accept="image/*" id="profilePicture">
                            <div class="form-text">
                                <small>JPG, PNG, GIF (Max: 2MB)</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- User Statistics -->
                <div class="card border-0 shadow-sm mt-4">
                    <div class="card-header bg-transparent border-0">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-chart-bar text-primary me-2"></i>
                            User Statistics
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <small class="text-muted">Member Since</small>
                            <p class="mb-0 fw-medium">{{ user.created_at.strftime('%B %d, %Y') if user.created_at else 'Unknown' }}</p>
                        </div>
                        
                        <div class="mb-3">
                            <small class="text-muted">Last Login</small>
                            <p class="mb-0 fw-medium">
                                {% if user.last_login %}
                                    {{ user.last_login.strftime('%B %d, %Y') }}
                                {% else %}
                                    <span class="text-muted">Never</span>
                                {% endif %}
                            </p>
                        </div>

                        {% if user.role == 'tutor' %}
                        <div class="mb-3">
                            <small class="text-muted">Classes Taught</small>
                            <p class="mb-0 fw-medium">{{ user.total_classes_taught or 0 }}</p>
                        </div>
                        
                        <div class="mb-0">
                            <small class="text-muted">Punctuality Score</small>
                            <div class="d-flex align-items-center">
                                <div class="progress flex-grow-1 me-2" style="height: 8px;">
                                    <div class="progress-bar bg-success" style="width: {{ user.punctuality_score or 100 }}%;"></div>
                                </div>
                                <span class="fw-medium">{{ "{:.0f}".format(user.punctuality_score or 100) }}%</span>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Emergency Contact -->
                <div class="card border-0 shadow-sm mt-4">
                    <div class="card-header bg-transparent border-0">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-phone-alt text-danger me-2"></i>
                            Emergency Contact
                        </h5>
                    </div>
                    <div class="card-body">
                        {% set emergency_contact = user.get_emergency_contact() %}
                        <div class="mb-3">
                            <label class="form-label">Contact Name</label>
                            <input type="text" name="emergency_contact_name" class="form-control" 
                                   value="{{ emergency_contact.name or '' }}" placeholder="Full name">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Contact Phone</label>
                            <input type="tel" name="emergency_contact_phone" class="form-control" 
                                   value="{{ emergency_contact.phone or '' }}" placeholder="Phone number">
                        </div>
                        
                        <div class="mb-0">
                            <label class="form-label">Relationship</label>
                            <select name="emergency_contact_relationship" class="form-select">
                                <option value="">Select Relationship</option>
                                <option value="spouse" {% if emergency_contact.relationship == 'spouse' %}selected{% endif %}>Spouse</option>
                                <option value="parent" {% if emergency_contact.relationship == 'parent' %}selected{% endif %}>Parent</option>
                                <option value="sibling" {% if emergency_contact.relationship == 'sibling' %}selected{% endif %}>Sibling</option>
                                <option value="child" {% if emergency_contact.relationship == 'child' %}selected{% endif %}>Child</option>
                                <option value="friend" {% if emergency_contact.relationship == 'friend' %}selected{% endif %}>Friend</option>
                                <option value="other" {% if emergency_contact.relationship == 'other' %}selected{% endif %}>Other</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Submit Actions -->
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="send_notification_email" 
                                           id="sendNotificationEmail">
                                    <label class="form-check-label" for="sendNotificationEmail">
                                        Send email notification about profile updates
                                    </label>
                                </div>
                                
                                <div class="alert alert-info mt-3 mb-0">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Note:</strong> Changes to role or department will affect the user's access permissions immediately.
                                </div>
                            </div>
                            
                            <div class="col-md-4 text-end">
                                <div class="btn-group">
                                    <a href="{{ url_for('view_user', id=user.id) }}" class="btn btn-outline-secondary">
                                        <i class="fas fa-times me-1"></i>
                                        Cancel
                                    </a>
                                    <button type="submit" class="btn btn-warning">
                                        <i class="fas fa-save me-1"></i>
                                        Update User
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<style>
.bg-gradient-warning {
    background: linear-gradient(135deg, #ffc107, #d39e00) !important;
}

.required::after {
    content: " *";
    color: #dc3545;
}

.avatar-preview {
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
    overflow: hidden;
}

.avatar-preview:hover {
    border-color: var(--primary-color) !important;
    transform: scale(1.05);
}

.avatar-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.progress {
    background-color: rgba(0,0,0,0.1);
}

.card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1) !important;
}

.form-control:focus,
.form-select:focus {
    border-color: var(--warning-color);
    box-shadow: 0 0 0 0.2rem rgba(255, 193, 7, 0.25);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const userRoleSelect = document.getElementById('userRole');
    const userDepartmentSelect = document.getElementById('userDepartment');
    const financeSection = document.getElementById('financeSection');
    const profilePictureInput = document.getElementById('profilePicture');
    const avatarPreview = document.getElementById('avatarPreview');

    // Handle role selection
    userRoleSelect.addEventListener('change', function() {
        const selectedRole = this.value;
        
        // Show/hide finance section for tutors
        if (selectedRole === 'tutor') {
            financeSection.style.display = 'block';
        } else {
            financeSection.style.display = 'none';
        }
        
        // Make department required for coordinators and tutors
        if (selectedRole === 'coordinator' || selectedRole === 'tutor') {
            userDepartmentSelect.required = true;
            userDepartmentSelect.parentElement.querySelector('.form-label').classList.add('required');
        } else {
            userDepartmentSelect.required = false;
            userDepartmentSelect.parentElement.querySelector('.form-label').classList.remove('required');
        }
    });

    // Handle profile picture preview
    profilePictureInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                avatarPreview.outerHTML = `<img src="${e.target.result}" alt="Profile Preview" class="rounded-circle" width="120" height="120" id="avatarPreview">`;
            };
            reader.readAsDataURL(file);
        }
    });

    // Form validation
    const form = document.querySelector('.needs-validation');
    form.addEventListener('submit', function(event) {
        if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
            LMS.showAlert('Please fill in all required fields correctly.', 'warning');
        }
        
        form.classList.add('was-validated');
    }, false);

    // Initialize role-dependent fields
    userRoleSelect.dispatchEvent(new Event('change'));
});
</script>
{% endblock %}