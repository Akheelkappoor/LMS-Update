{% extends "base.html" %}

{% block title %}Register New Tutor - LMS{% endblock %}

{% block content %}
<div class="page-header">
    <div class="header-content">
        <h1 class="page-title">
            <i class="fas fa-user-plus"></i>
            Register New Tutor
        </h1>
    </div>
</div>

<div class="tutor-registration-container">
    <form method="POST" enctype="multipart/form-data" class="tutor-form">
        <!-- Personal Information -->
        <div class="form-section">
            <h3><i class="fas fa-user"></i> Personal Information</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label required">Full Name</label>
                    <input type="text" name="full_name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label required">Email</label>
                    <input type="email" name="email" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label required">Phone</label>
                    <input type="tel" name="phone" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label required">Username</label>
                    <input type="text" name="username" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label required">Password</label>
                    <input type="password" name="password" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label required">Department</label>
                    <select name="department_id" class="form-control" required id="tutorDepartment">
                        <option value="">Select Department</option>
                        {% for dept in departments %}
                        <option value="{{ dept.id }}">{{ dept.name }} ({{ dept.code }})</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        <!-- Department-Specific Form (Dynamic) -->
        <div id="departmentDynamicForm" class="form-section" style="display: none;">
            <!-- Dynamic form fields will be loaded here -->
        </div>

        <!-- Documents -->
        <div class="form-section">
            <h3><i class="fas fa-file"></i> Documents</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Resume</label>
                    <input type="file" name="resume" class="form-control" accept=".pdf,.doc,.docx">
                </div>
                <div class="form-group">
                    <label class="form-label">ID Proof</label>
                    <input type="file" name="id_proof" class="form-control" accept=".pdf,.jpg,.jpeg,.png">
                </div>
            </div>
        </div>

        <!-- Submit Button -->
        <div class="form-actions">
            <button type="submit" class="btn btn-primary btn-lg">
                <i class="fas fa-check"></i>
                Register Tutor
            </button>
            <a href="{{ url_for('tutor_management') }}" class="btn btn-secondary">
                Cancel
            </a>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const departmentSelect = document.getElementById('tutorDepartment');
    let dynamicFormContainer = document.getElementById('departmentDynamicForm');
    
    if (departmentSelect) {
        departmentSelect.addEventListener('change', function() {
            const departmentId = this.value;
            
            if (departmentId) {
                loadTutorDepartmentForm(departmentId);
            } else {
                clearDynamicForm();
            }
        });
    }
    
    function loadTutorDepartmentForm(departmentId) {
        if (!dynamicFormContainer) return;
        
        // Show loading
        dynamicFormContainer.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
                <p class="mt-2">Loading department form...</p>
            </div>
        `;
        dynamicFormContainer.style.display = 'block';
        
        // Fetch tutor form for this department
        fetch(`/api/departments/${departmentId}/form?type=tutor`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('No form assigned');
                }
                return response.json();
            })
            .then(data => {
                renderTutorForm(data.form);
            })
            .catch(error => {
                console.log('No department form found');
                clearDynamicForm();
            });
    }
    
    function renderTutorForm(form) {
        if (!dynamicFormContainer || !form.fields || form.fields.length === 0) {
            clearDynamicForm();
            return;
        }
        
        let fieldsHTML = '';
        
        form.fields.forEach(field => {
            fieldsHTML += generateTutorFieldHTML(field);
        });
        
        dynamicFormContainer.innerHTML = `
            <h3><i class="fas fa-building"></i> ${form.name}</h3>
            ${form.description ? `<p class="text-muted">${form.description}</p>` : ''}
            <div class="form-grid">
                ${fieldsHTML}
            </div>
        `;
        
        dynamicFormContainer.style.display = 'block';
    }
    
    function generateTutorFieldHTML(field) {
        const required = field.required ? 'required' : '';
        const requiredLabel = field.required ? '<span class="text-danger">*</span>' : '';
        
        let inputHTML = '';
        
        switch(field.type) {
            case 'text':
            case 'email':
            case 'tel':
            case 'url':
                inputHTML = `<input type="${field.type}" name="custom_${field.name}" class="form-control" ${required}>`;
                break;
                
            case 'number':
                inputHTML = `<input type="number" name="custom_${field.name}" class="form-control" ${required}>`;
                break;
                
            case 'date':
                inputHTML = `<input type="date" name="custom_${field.name}" class="form-control" ${required}>`;
                break;
                
            case 'textarea':
                inputHTML = `<textarea name="custom_${field.name}" class="form-control" rows="3" ${required}></textarea>`;
                break;
                
            case 'select':
                let options = '<option value="">Select...</option>';
                if (field.options) {
                    field.options.forEach(option => {
                        options += `<option value="${option}">${option}</option>`;
                    });
                }
                inputHTML = `<select name="custom_${field.name}" class="form-control" ${required}>${options}</select>`;
                break;
                
            case 'radio':
                if (field.options) {
                    field.options.forEach(option => {
                        inputHTML += `
                            <div class="form-check">
                                <input type="radio" name="custom_${field.name}" value="${option}" class="form-check-input" ${required}>
                                <label class="form-check-label">${option}</label>
                            </div>
                        `;
                    });
                }
                break;
                
            case 'checkbox':
                if (field.options) {
                    field.options.forEach(option => {
                        inputHTML += `
                            <div class="form-check">
                                <input type="checkbox" name="custom_${field.name}[]" value="${option}" class="form-check-input">
                                <label class="form-check-label">${option}</label>
                            </div>
                        `;
                    });
                }
                break;
                
            case 'file':
                inputHTML = `<input type="file" name="custom_file_${field.name}" class="form-control" ${required}>`;
                break;
        }
        
        return `
            <div class="form-group">
                <label class="form-label">${field.label} ${requiredLabel}</label>
                ${inputHTML}
                ${field.description ? `<small class="form-text text-muted">${field.description}</small>` : ''}
            </div>
        `;
    }
    
    function clearDynamicForm() {
        if (dynamicFormContainer) {
            dynamicFormContainer.style.display = 'none';
            dynamicFormContainer.innerHTML = '';
        }
    }
});

function toggleTutorStatus(tutorId) {
    if (confirm('Are you sure you want to change this tutor\'s status?')) {
        fetch(`/tutors/${tutorId}/toggle-status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload(); // Refresh page to show updated status
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error updating tutor status');
        });
    }
}
</script>

<style>
.tutor-registration-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 32px;
}

.tutor-form {
    background: white;
    border-radius: 16px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    overflow: hidden;
}

.form-section {
    padding: 32px;
    border-bottom: 1px solid #e9ecef;
}

.form-section:last-child {
    border-bottom: none;
}

.form-section h3 {
    color: #333;
    margin-bottom: 24px;
    display: flex;
    align-items: center;
    gap: 12px;
}

.form-section h3 i {
    color: #F1A150;
}

.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
}

.form-actions {
    padding: 32px;
    background: #f8f9fa;
    display: flex;
    gap: 16px;
    justify-content: center;
}

.tutor-card {
    background: white;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 16px;
}

.tutor-info h3 {
    margin: 0 0 8px 0;
    color: #333;
}

.tutor-actions {
    display: flex;
    gap: 8px;
    margin-top: 16px;
}
</style>
{% endblock %}