{% extends "base.html" %}

{% block title %}Form Templates - LMS{% endblock %}

{% block content %}
<div class="page-header">
    <div class="header-content">
        <h1 class="page-title">
            <i class="fas fa-file-alt"></i>
            Form Templates
        </h1>
        <div class="header-actions">
            <a href="{{ url_for('create_form') }}" class="btn btn-primary">
                <i class="fas fa-plus"></i>
                Create Form
            </a>
        </div>
    </div>
</div>

<div class="forms-grid">
    {% for form in forms %}
    <div class="form-card">
        <div class="form-icon">
            <i class="fas fa-{{ 'user' if form.form_type == 'user' else 'chalkboard-teacher' if form.form_type == 'tutor' else 'user-graduate' if form.form_type == 'student' else 'file-alt' }}"></i>
        </div>
        
        <h3 class="form-name">{{ form.name }}</h3>
        <p class="form-description">{{ form.description or 'No description' }}</p>
        
        <div class="form-meta">
            <span class="meta-item">
                <i class="fas fa-layer-group"></i>
                {{ form.fields|length }} Fields
            </span>
            <span class="meta-item">
                <i class="fas fa-tag"></i>
                {{ form.form_type|title }}
            </span>
        </div>
        
        <div class="form-stats">
            <span class="stat-item">
                Created {{ form.created_at.strftime('%b %d, %Y') }}
            </span>
        </div>
        
        <div class="form-actions">
            <button class="btn btn-sm btn-secondary" onclick="previewForm('{{ form.id }}')">
                <i class="fas fa-eye"></i>
                Preview
            </button>
            <button class="btn btn-sm btn-primary" onclick="assignForm('{{ form.id }}')">
                <i class="fas fa-link"></i>
                Assign
            </button>
            <button class="btn btn-sm btn-secondary" onclick="editForm('{{ form.id }}')">
                <i class="fas fa-edit"></i>
                Edit
            </button>
        </div>
        
        {% if form.is_active %}
        <span class="status-badge active">Active</span>
        {% else %}
        <span class="status-badge inactive">Inactive</span>
        {% endif %}
    </div>
    {% endfor %}
    
    {% if not forms %}
    <div class="empty-state-card">
        <i class="fas fa-file-alt"></i>
        <h3>No Forms Created Yet</h3>
        <p>Create your first form template to collect custom information</p>
        <a href="{{ url_for('create_form') }}" class="btn btn-primary">
            <i class="fas fa-plus"></i>
            Create First Form
        </a>
    </div>
    {% endif %}
</div>

<!-- Modal for Assigning Form -->
<div id="assignModal" class="modal" style="display:none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Assign Form to Departments</h3>
      <button onclick="closeAssignModal()" style="background:none;border:none;font-size:1.5em;cursor:pointer;">&times;</button>
    </div>
    <div class="modal-body">
      <label for="assignmentType"><strong>Assignment Type:</strong></label>
      <select id="assignmentType" style="margin-bottom:16px;">
        <option value="user">User Form</option>
        <option value="tutor">Tutor Form</option>
      </select>
      <div id="departmentsList" class="departments-list">
        <!-- Departments will be loaded here -->
      </div>
    </div>
    <div class="modal-footer">
      <button onclick="closeAssignModal()" class="btn btn-secondary">Cancel</button>
      <button onclick="saveAssignment(event)" class="btn btn-primary">Assign</button>
    </div>
  </div>
</div>

<style>
.forms-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 24px;
    padding: 32px;
    max-width: 1400px;
    margin: 0 auto;
}

.form-card {
    background: white;
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    position: relative;
    transition: all 0.3s ease;
    border: 1px solid rgba(0, 0, 0, 0.1);
}

.form-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
}

.form-icon {
    width: 56px;
    height: 56px;
    background: linear-gradient(45deg, rgba(241, 161, 80, 0.1), rgba(200, 103, 6, 0.1));
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 20px;
}

.form-icon i {
    font-size: 24px;
    color: #F1A150;
}

.form-name {
    font-size: 20px;
    font-weight: 600;
    color: rgb(34, 34, 34);
    margin-bottom: 8px;
}

.form-description {
    font-size: 14px;
    color: rgb(68, 68, 68);
    margin-bottom: 20px;
    line-height: 1.6;
}

.form-meta {
    display: flex;
    gap: 16px;
    margin-bottom: 16px;
}

.meta-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: rgb(68, 68, 68);
}

.meta-item i {
    color: #F1A150;
}

.form-stats {
    font-size: 13px;
    color: rgb(68, 68, 68);
    margin-bottom: 20px;
    padding-top: 16px;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
}

.form-actions {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

.btn-sm {
    padding: 8px 16px;
    font-size: 13px;
    border-radius: 8px;
}

.status-badge {
    position: absolute;
    top: 20px;
    right: 20px;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
}

.status-badge.active {
    background: rgba(40, 167, 69, 0.1);
    color: #28a745;
}

.status-badge.inactive {
    background: rgba(108, 117, 125, 0.1);
    color: #6c757d;
}

/* Modal improvements */
.modal {
    backdrop-filter: blur(8px);
    padding: 20px;
}

.modal-content {
    background: white;
    border-radius: 16px;
    width: 100%;
    max-width: 600px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
}

.modal-header {
    padding: 24px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    background: linear-gradient(to right, rgba(241, 161, 80, 0.1), transparent);
}

.modal-header h3 {
    font-size: 20px;
    font-weight: 600;
    color: rgb(34, 34, 34);
}

.modal-body {
    padding: 24px;
}

.modal-footer {
    padding: 24px;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
}

.department-checkbox {
    margin-bottom: 12px;
    padding: 12px 16px;
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 12px;
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.department-checkbox:hover {
    border-color: #F1A150;
    background: rgba(241, 161, 80, 0.05);
}

/* Empty state improvements */
.empty-state-card {
    grid-column: 1 / -1;
    text-align: center;
    padding: 80px 40px;
    background: rgba(241, 161, 80, 0.05);
    border-radius: 16px;
    border: 2px dashed rgba(241, 161, 80, 0.3);
}

.empty-state-card i {
    font-size: 64px;
    color: #F1A150;
    margin-bottom: 24px;
}

.empty-state-card h3 {
    font-size: 24px;
    color: rgb(34, 34, 34);
    margin-bottom: 12px;
}

.empty-state-card p {
    font-size: 16px;
    color: rgb(85, 85, 85);
    margin-bottom: 24px;
}

/* Modal for Assigning Form */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-content {
    background: white;
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
    max-height: 80vh;
    overflow-y: auto;
}

.modal-header {
    padding: 20px 24px;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
    flex: 1;
}

.modal-body {
    padding: 24px;
}

.modal-footer {
    padding: 16px 24px;
    border-top: 1px solid #e9ecef;
    display: flex;
    gap: 12px;
    justify-content: flex-end;
}

.departments-list {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 12px;
}

.department-checkbox {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 12px;
    border-bottom: 1px solid #f1f3f4;
    cursor: pointer;
}

.department-checkbox:hover {
    background: #f8f9fa;
}

.department-checkbox:last-child {
    border-bottom: none;
}

.checkbox-text {
    flex: 1;
}

.form-assignments {
    color: #666;
    font-size: 0.85em;
}
</style>

<script>
let selectedFormId = null;

function previewForm(formId) {
    window.open(`{{ url_for('preview_form', id=0) }}`.replace('0', formId), '_blank');
}

function editForm(formId) {
    // TODO: Implement edit functionality
    alert('Edit functionality coming soon!');
}

function assignForm(formId) {
    selectedFormId = formId;
    
    // Load departments
    fetch('/api/departments')
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to load departments');
            }
            return response.json();
        })
        .then(departments => {
            const container = document.getElementById('departmentsList');
            if (!container) {
                console.error('Department list container not found');
                return;
            }
            
            container.innerHTML = departments.map(dept => `
                <label class="department-checkbox">
                    <input type="checkbox" value="${dept.id}" name="departments">
                    <span class="checkbox-text">
                        <strong>${dept.name}</strong> (${dept.code})
                        <br>
                        <small class="form-assignments">
                            User Form: ${dept.user_form_id ? 'Assigned' : 'None'} | 
                            Tutor Form: ${dept.tutor_form_id ? 'Assigned' : 'None'}
                        </small>
                    </span>
                </label>
            `).join('');
        })
        .catch(error => {
            console.error('Error loading departments:', error);
            alert('Failed to load departments. Please try again.');
        });
    
    document.getElementById('assignModal').style.display = 'flex';
}

function closeAssignModal() {
    document.getElementById('assignModal').style.display = 'none';
    selectedFormId = null;
}

function saveAssignment(event) {
    const checkedDepts = Array.from(document.querySelectorAll('input[name="departments"]:checked'))
        .map(cb => parseInt(cb.value));
    
    if (checkedDepts.length === 0) {
        alert('Please select at least one department');
        return;
    }
    
    const assignmentType = document.getElementById('assignmentType').value;
    
    // Show loading state
    const saveBtn = event.target;
    const originalText = saveBtn.textContent;
    saveBtn.textContent = 'Assigning...';
    saveBtn.disabled = true;
    
    fetch(`/forms/${selectedFormId}/assign`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            departments: checkedDepts,
            type: assignmentType
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            closeAssignModal();
            // Optionally reload the page to show updated assignments
            window.location.reload();
        } else {
            throw new Error(data.error || 'Assignment failed');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error assigning form: ' + error.message);
    })
    .finally(() => {
        // Restore button state
        saveBtn.textContent = originalText;
        saveBtn.disabled = false;
    });
}

// Modal styles
const modalStyles = `
<style>
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-content {
    background: white;
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
    max-height: 80vh;
    overflow-y: auto;
}

.modal-header {
    padding: 20px 24px;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
    flex: 1;
}

.modal-body {
    padding: 24px;
}

.modal-footer {
    padding: 16px 24px;
    border-top: 1px solid #e9ecef;
    display: flex;
    gap: 12px;
    justify-content: flex-end;
}

.departments-list {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 12px;
}

.department-checkbox {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 12px;
    border-bottom: 1px solid #f1f3f4;
    cursor: pointer;
}

.department-checkbox:hover {
    background: #f8f9fa;
}

.department-checkbox:last-child {
    border-bottom: none;
}

.checkbox-text {
    flex: 1;
}

.form-assignments {
    color: #666;
    font-size: 0.85em;
}
</style>
`;

document.head.insertAdjacentHTML('beforeend', modalStyles);
</script>
{% endblock %}