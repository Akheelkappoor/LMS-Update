{% extends "base.html" %}

{% block title %}Create Feedback Form - LMS{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Header -->
    <div class="dashboard-header">
        <h1 class="dashboard-title">
            <i class="fas fa-magic"></i> Create Feedback Form
        </h1>
        <p class="dashboard-subtitle">Design custom feedback forms for class sessions</p>
    </div>

    <form method="POST" id="feedbackFormBuilder">
        <!-- Form Settings -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-cog"></i> Form Settings
                </h3>
            </div>
            <div class="card-body">
                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label class="form-label required">Form Name</label>
                        <input type="text" name="form_name" class="form-control" required 
                               placeholder="e.g., K12 Class Feedback Form">
                    </div>
                    <div class="form-group col-md-6">
                        <label class="form-label">Department</label>
                        <select name="department_id" class="form-control">
                            <option value="">All Departments</option>
                            {% for dept in departments %}
                            <option value="{{ dept.id }}">{{ dept.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group col-md-4">
                        <label class="form-label">Subject (Optional)</label>
                        <input type="text" name="subject" class="form-control" 
                               placeholder="e.g., Mathematics">
                    </div>
                    <div class="form-group col-md-4">
                        <label class="form-label">Class Type</label>
                        <select name="class_type" class="form-control">
                            <option value="">All Class Types</option>
                            <option value="regular">Regular Classes</option>
                            <option value="demo">Demo Classes</option>
                            <option value="makeup">Makeup Classes</option>
                            <option value="assessment">Assessment Classes</option>
                        </select>
                    </div>
                    <div class="form-group col-md-4">
                        <label class="form-label">Submission Deadline (Hours)</label>
                        <input type="number" name="deadline_hours" class="form-control" value="3" min="1" max="24">
                        <small class="form-text">Hours after class end to submit feedback</small>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label class="form-label">Description</label>
                        <textarea name="description" class="form-control" rows="3" 
                                  placeholder="Brief description of this feedback form..."></textarea>
                    </div>
                    <div class="form-group col-md-6">
                        <div class="form-options">
                            <label class="checkbox-label">
                                <input type="checkbox" name="is_mandatory" checked>
                                Mandatory for all sessions
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="allow_partial_submission">
                                Allow partial submission
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="require_approval">
                                Require supervisor approval
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Form Builder -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-puzzle-piece"></i> Form Builder
                </h3>
                <div class="header-actions">
                    <button type="button" class="btn btn-sm btn-success" onclick="addField('text')">
                        <i class="fas fa-plus"></i> Add Text Field
                    </button>
                    <button type="button" class="btn btn-sm btn-info" onclick="addField('rating')">
                        <i class="fas fa-star"></i> Add Rating
                    </button>
                    <button type="button" class="btn btn-sm btn-warning" onclick="addField('dropdown')">
                        <i class="fas fa-list"></i> Add Dropdown
                    </button>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="previewForm()">
                        <i class="fas fa-eye"></i> Preview
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- Field Templates (Hidden) -->
                <div id="fieldTemplates" style="display: none;">
                    <div class="field-template" data-type="text">
                        <div class="form-field" data-field-id="">
                            <div class="field-header">
                                <div class="field-type-badge">Text Field</div>
                                <div class="field-actions">
                                    <button type="button" class="btn-icon" onclick="moveFieldUp(this)">
                                        <i class="fas fa-arrow-up"></i>
                                    </button>
                                    <button type="button" class="btn-icon" onclick="moveFieldDown(this)">
                                        <i class="fas fa-arrow-down"></i>
                                    </button>
                                    <button type="button" class="btn-icon" onclick="editField(this)">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button type="button" class="btn-icon danger" onclick="removeField(this)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="field-preview">
                                <label class="field-label">Sample Text Field</label>
                                <input type="text" class="form-control" placeholder="Text input field" disabled>
                            </div>
                        </div>
                    </div>

                    <div class="field-template" data-type="rating">
                        <div class="form-field" data-field-id="">
                            <div class="field-header">
                                <div class="field-type-badge rating">Rating Field</div>
                                <div class="field-actions">
                                    <button type="button" class="btn-icon" onclick="moveFieldUp(this)">
                                        <i class="fas fa-arrow-up"></i>
                                    </button>
                                    <button type="button" class="btn-icon" onclick="moveFieldDown(this)">
                                        <i class="fas fa-arrow-down"></i>
                                    </button>
                                    <button type="button" class="btn-icon" onclick="editField(this)">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button type="button" class="btn-icon danger" onclick="removeField(this)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="field-preview">
                                <label class="field-label">Sample Rating Field</label>
                                <div class="rating-preview">
                                    <span>1</span>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <span>5</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="field-template" data-type="dropdown">
                        <div class="form-field" data-field-id="">
                            <div class="field-header">
                                <div class="field-type-badge dropdown">Dropdown Field</div>
                                <div class="field-actions">
                                    <button type="button" class="btn-icon" onclick="moveFieldUp(this)">
                                        <i class="fas fa-arrow-up"></i>
                                    </button>
                                    <button type="button" class="btn-icon" onclick="moveFieldDown(this)">
                                        <i class="fas fa-arrow-down"></i>
                                    </button>
                                    <button type="button" class="btn-icon" onclick="editField(this)">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button type="button" class="btn-icon danger" onclick="removeField(this)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="field-preview">
                                <label class="field-label">Sample Dropdown Field</label>
                                <select class="form-control" disabled>
                                    <option>Select an option...</option>
                                    <option>Option 1</option>
                                    <option>Option 2</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Form Fields Container -->
                <div id="formFields" class="form-fields-container">
                    <div class="empty-form-state">
                        <i class="fas fa-puzzle-piece"></i>
                        <h3>Start Building Your Form</h3>
                        <p>Add fields using the buttons above to create your custom feedback form.</p>
                    </div>
                </div>

                <!-- Hidden input to store form fields JSON -->
                <input type="hidden" name="form_fields" id="formFieldsData">
            </div>
        </div>

        <!-- Common Fields Library -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-bookmark"></i> Quick Add Common Fields
                </h3>
            </div>
            <div class="card-body">
                <div class="common-fields">
                    <button type="button" class="common-field-btn" onclick="addCommonField('overall_rating')">
                        <i class="fas fa-star"></i>
                        <span>Overall Rating</span>
                    </button>
                    <button type="button" class="common-field-btn" onclick="addCommonField('student_engagement')">
                        <i class="fas fa-users"></i>
                        <span>Student Engagement</span>
                    </button>
                    <button type="button" class="common-field-btn" onclick="addCommonField('class_completion')">
                        <i class="fas fa-percentage"></i>
                        <span>Class Completion %</span>
                    </button>
                    <button type="button" class="common-field-btn" onclick="addCommonField('technical_issues')">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>Technical Issues</span>
                    </button>
                    <button type="button" class="common-field-btn" onclick="addCommonField('homework_assigned')">
                        <i class="fas fa-book"></i>
                        <span>Homework Assigned</span>
                    </button>
                    <button type="button" class="common-field-btn" onclick="addCommonField('class_objectives_met')">
                        <i class="fas fa-bullseye"></i>
                        <span>Objectives Met</span>
                    </button>
                    <button type="button" class="common-field-btn" onclick="addCommonField('student_questions')">
                        <i class="fas fa-question-circle"></i>
                        <span>Student Questions</span>
                    </button>
                    <button type="button" class="common-field-btn" onclick="addCommonField('followup_needed')">
                        <i class="fas fa-flag"></i>
                        <span>Follow-up Needed</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
            <button type="submit" class="btn btn-primary btn-lg">
                <i class="fas fa-save"></i> Create Feedback Form
            </button>
            <button type="button" class="btn btn-secondary btn-lg" onclick="saveDraft()">
                <i class="fas fa-draft2digital"></i> Save as Draft
            </button>
            <a href="{{ url_for('feedback_forms') }}" class="btn btn-outline-secondary btn-lg">
                <i class="fas fa-times"></i> Cancel
            </a>
        </div>
    </form>
</div>

<!-- Field Editor Modal -->
<div class="modal fade" id="fieldEditorModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Field</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="fieldEditorForm">
                    <div class="form-group">
                        <label class="form-label required">Field Label</label>
                        <input type="text" id="fieldLabel" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Field Name (System)</label>
                        <input type="text" id="fieldName" class="form-control" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Placeholder Text</label>
                        <input type="text" id="fieldPlaceholder" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Help Text</label>
                        <textarea id="fieldHelpText" class="form-control" rows="2"></textarea>
                    </div>
                    
                    <div class="form-group" id="fieldOptionsGroup" style="display: none;">
                        <label class="form-label">Options</label>
                        <div id="fieldOptions">
                            <div class="option-item">
                                <input type="text" class="form-control option-input" placeholder="Option 1">
                                <button type="button" class="btn btn-sm btn-danger" onclick="removeOption(this)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <button type="button" class="btn btn-sm btn-success" onclick="addOption()">
                            <i class="fas fa-plus"></i> Add Option
                        </button>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label class="checkbox-label">
                                <input type="checkbox" id="fieldRequired">
                                Required Field
                            </label>
                        </div>
                        <div class="form-group col-md-6">
                            <label class="form-label">Field Width</label>
                            <select id="fieldWidth" class="form-control">
                                <option value="full">Full Width</option>
                                <option value="half">Half Width</option>
                                <option value="third">One Third</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveFieldEdit()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Form Preview Modal -->
<div class="modal fade" id="formPreviewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Form Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="formPreviewContent">
                    <!-- Preview content will be generated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<style>
/* Form Builder Styles */
.header-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.form-options {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.checkbox-label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
}

.form-fields-container {
    min-height: 200px;
    border: 2px dashed var(--border-color);
    border-radius: 12px;
    padding: 20px;
}

.empty-form-state {
    text-align: center;
    color: var(--text-secondary);
}

.empty-form-state i {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.5;
}

.form-field {
    background: white;
    border: 1px solid var(--border-color);
    border-radius: 12px;
    margin-bottom: 16px;
    overflow: hidden;
    transition: var(--transition);
}

.form-field:hover {
    box-shadow: var(--shadow);
}

.field-header {
    background: var(--light-color);
    padding: 12px 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--border-color);
}

.field-type-badge {
    background: var(--primary-color);
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
}

.field-type-badge.rating {
    background: var(--warning-color);
}

.field-type-badge.dropdown {
    background: var(--info-color);
}

.field-actions {
    display: flex;
    gap: 4px;
}

.btn-icon {
    background: none;
    border: none;
    padding: 6px;
    border-radius: 6px;
    cursor: pointer;
    color: var(--text-secondary);
    transition: var(--transition);
}

.btn-icon:hover {
    background: var(--border-color);
    color: var(--text-primary);
}

.btn-icon.danger:hover {
    background: var(--danger-color);
    color: white;
}

.field-preview {
    padding: 16px;
}

.field-label {
    font-weight: 600;
    margin-bottom: 8px;
    display: block;
}

.rating-preview {
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--warning-color);
}

.common-fields {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 12px;
}

.common-field-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    padding: 16px;
    background: var(--light-color);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    cursor: pointer;
    transition: var(--transition);
    text-decoration: none;
    color: var(--text-primary);
}

.common-field-btn:hover {
    background: var(--primary-color);
    color: white;
    transform: translateY(-2px);
}

.common-field-btn i {
    font-size: 20px;
}

.common-field-btn span {
    font-size: 12px;
    font-weight: 500;
    text-align: center;
}

.option-item {
    display: flex;
    gap: 8px;
    margin-bottom: 8px;
    align-items: center;
}

.option-input {
    flex: 1;
}

/* Form Actions */
.form-actions {
    display: flex;
    gap: 16px;
    justify-content: center;
    margin-top: 32px;
    padding-top: 24px;
    border-top: 1px solid var(--border-color);
}

/* Responsive */
@media (max-width: 768px) {
    .header-actions {
        justify-content: center;
    }
    
    .common-fields {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    }
    
    .form-actions {
        flex-direction: column;
    }
}
</style>

<script>
let fieldCounter = 0;
let formFields = [];
let currentEditingField = null;

// Field management functions
function addField(type) {
    fieldCounter++;
    const fieldId = `field_${fieldCounter}`;
    const template = document.querySelector(`[data-type="${type}"]`).cloneNode(true);
    const formField = template.querySelector('.form-field');
    
    formField.setAttribute('data-field-id', fieldId);
    formField.setAttribute('data-field-type', type);
    
    // Clear empty state
    const emptyState = document.querySelector('.empty-form-state');
    if (emptyState) {
        emptyState.remove();
    }
    
    // Add to container
    document.getElementById('formFields').appendChild(formField);
    
    // Create field data
    const fieldData = createFieldData(type, fieldId);
    formFields.push(fieldData);
    
    // Update hidden input
    updateFormFieldsData();
    
    // Scroll to new field
    formField.scrollIntoView({ behavior: 'smooth' });
}

function createFieldData(type, fieldId) {
    const baseData = {
        id: fieldId,
        name: fieldId,
        type: type,
        label: `${type.charAt(0).toUpperCase() + type.slice(1)} Field`,
        required: false,
        width: 'full',
        order: fieldCounter
    };
    
    switch (type) {
        case 'text':
            return {
                ...baseData,
                placeholder: 'Enter text...',
                maxLength: null
            };
        case 'rating':
            return {
                ...baseData,
                minValue: 1,
                maxValue: 5,
                scale: 'stars'
            };
        case 'dropdown':
            return {
                ...baseData,
                options: ['Option 1', 'Option 2'],
                multiple: false
            };
        default:
            return baseData;
    }
}

function addCommonField(fieldType) {
    const commonFields = {
        overall_rating: {
            type: 'rating',
            label: 'Overall Rating',
            name: 'overall_rating',
            required: true
        },
        student_engagement: {
            type: 'rating',
            label: 'Student Engagement Level',
            name: 'student_engagement',
            required: false
        },
        class_completion: {
            type: 'number',
            label: 'Class Completion Percentage',
            name: 'class_completion',
            required: false,
            min: 0,
            max: 100
        },
        technical_issues: {
            type: 'dropdown',
            label: 'Technical Issues Encountered',
            name: 'technical_issues',
            required: false,
            options: ['None', 'Minor issues', 'Major issues', 'Class disrupted']
        },
        homework_assigned: {
            type: 'dropdown',
            label: 'Homework Assigned',
            name: 'homework_assigned',
            required: false,
            options: ['Yes', 'No', 'Review only']
        },
        class_objectives_met: {
            type: 'dropdown',
            label: 'Class Objectives Met',
            name: 'class_objectives_met',
            required: false,
            options: ['Fully achieved', 'Mostly achieved', 'Partially achieved', 'Not achieved']
        },
        student_questions: {
            type: 'text',
            label: 'Student Questions/Concerns',
            name: 'student_questions',
            required: false,
            placeholder: 'Describe any questions or concerns raised by students...'
        },
        followup_needed: {
            type: 'dropdown',
            label: 'Follow-up Action Required',
            name: 'followup_needed',
            required: false,
            options: ['None', 'Additional practice needed', 'Parent meeting required', 'Curriculum adjustment needed']
        }
    };
    
    const fieldData = commonFields[fieldType];
    if (fieldData) {
        fieldCounter++;
        fieldData.id = `field_${fieldCounter}`;
        fieldData.order = fieldCounter;
        
        formFields.push(fieldData);
        renderField(fieldData);
        updateFormFieldsData();
    }
}

function renderField(fieldData) {
    // Clear empty state
    const emptyState = document.querySelector('.empty-form-state');
    if (emptyState) {
        emptyState.remove();
    }
    
    const fieldElement = document.createElement('div');
    fieldElement.className = 'form-field';
    fieldElement.setAttribute('data-field-id', fieldData.id);
    fieldElement.setAttribute('data-field-type', fieldData.type);
    
    fieldElement.innerHTML = `
        <div class="field-header">
            <div class="field-type-badge ${fieldData.type}">${fieldData.type.charAt(0).toUpperCase() + fieldData.type.slice(1)} Field</div>
            <div class="field-actions">
                <button type="button" class="btn-icon" onclick="moveFieldUp(this)">
                    <i class="fas fa-arrow-up"></i>
                </button>
                <button type="button" class="btn-icon" onclick="moveFieldDown(this)">
                    <i class="fas fa-arrow-down"></i>
                </button>
                <button type="button" class="btn-icon" onclick="editField(this)">
                    <i class="fas fa-edit"></i>
                </button>
                <button type="button" class="btn-icon danger" onclick="removeField(this)">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
        <div class="field-preview">
            ${generateFieldPreview(fieldData)}
        </div>
    `;
    
    document.getElementById('formFields').appendChild(fieldElement);
}

function generateFieldPreview(fieldData) {
    let preview = `<label class="field-label">${fieldData.label}${fieldData.required ? ' *' : ''}</label>`;
    
    switch (fieldData.type) {
        case 'text':
            preview += `<input type="text" class="form-control" placeholder="${fieldData.placeholder || ''}" disabled>`;
            break;
        case 'rating':
            preview += `
                <div class="rating-preview">
                    <span>${fieldData.minValue || 1}</span>
                    ${Array(fieldData.maxValue || 5).fill('<i class="fas fa-star"></i>').join('')}
                    <span>${fieldData.maxValue || 5}</span>
                </div>
            `;
            break;
        case 'dropdown':
            preview += `
                <select class="form-control" disabled>
                    <option>Select an option...</option>
                    ${(fieldData.options || []).map(opt => `<option>${opt}</option>`).join('')}
                </select>
            `;
            break;
        case 'number':
            preview += `<input type="number" class="form-control" placeholder="Enter number..." disabled>`;
            break;
    }
    
    if (fieldData.helpText) {
        preview += `<small class="form-text text-muted">${fieldData.helpText}</small>`;
    }
    
    return preview;
}

function editField(button) {
    const fieldElement = button.closest('.form-field');
    const fieldId = fieldElement.getAttribute('data-field-id');
    const fieldData = formFields.find(f => f.id === fieldId);
    
    if (fieldData) {
        currentEditingField = fieldData;
        populateFieldEditor(fieldData);
        new bootstrap.Modal(document.getElementById('fieldEditorModal')).show();
    }
}

function populateFieldEditor(fieldData) {
    document.getElementById('fieldLabel').value = fieldData.label;
    document.getElementById('fieldName').value = fieldData.name;
    document.getElementById('fieldPlaceholder').value = fieldData.placeholder || '';
    document.getElementById('fieldHelpText').value = fieldData.helpText || '';
    document.getElementById('fieldRequired').checked = fieldData.required;
    document.getElementById('fieldWidth').value = fieldData.width || 'full';
    
    // Handle options for dropdown fields
    const optionsGroup = document.getElementById('fieldOptionsGroup');
    if (fieldData.type === 'dropdown' && fieldData.options) {
        optionsGroup.style.display = 'block';
        const optionsContainer = document.getElementById('fieldOptions');
        optionsContainer.innerHTML = '';
        
        fieldData.options.forEach(option => {
            const optionItem = document.createElement('div');
            optionItem.className = 'option-item';
            optionItem.innerHTML = `
                <input type="text" class="form-control option-input" value="${option}">
                <button type="button" class="btn btn-sm btn-danger" onclick="removeOption(this)">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            optionsContainer.appendChild(optionItem);
        });
    } else {
        optionsGroup.style.display = 'none';
    }
}

function saveFieldEdit() {
    if (!currentEditingField) return;
    
    // Update field data
    currentEditingField.label = document.getElementById('fieldLabel').value;
    currentEditingField.placeholder = document.getElementById('fieldPlaceholder').value;
    currentEditingField.helpText = document.getElementById('fieldHelpText').value;
    currentEditingField.required = document.getElementById('fieldRequired').checked;
    currentEditingField.width = document.getElementById('fieldWidth').value;
    
    // Update options for dropdown fields
    if (currentEditingField.type === 'dropdown') {
        const optionInputs = document.querySelectorAll('.option-input');
        currentEditingField.options = Array.from(optionInputs).map(input => input.value).filter(val => val.trim());
    }
    
    // Re-render the field
    const fieldElement = document.querySelector(`[data-field-id="${currentEditingField.id}"]`);
    if (fieldElement) {
        const preview = fieldElement.querySelector('.field-preview');
        preview.innerHTML = generateFieldPreview(currentEditingField);
    }
    
    // Update form data
    updateFormFieldsData();
    
    // Close modal
    bootstrap.Modal.getInstance(document.getElementById('fieldEditorModal')).hide();
    currentEditingField = null;
}

function addOption() {
    const optionsContainer = document.getElementById('fieldOptions');
    const optionItem = document.createElement('div');
    optionItem.className = 'option-item';
    optionItem.innerHTML = `
        <input type="text" class="form-control option-input" placeholder="New option">
        <button type="button" class="btn btn-sm btn-danger" onclick="removeOption(this)">
            <i class="fas fa-trash"></i>
        </button>
    `;
    optionsContainer.appendChild(optionItem);
}

function removeOption(button) {
    button.closest('.option-item').remove();
}

function removeField(button) {
    if (confirm('Are you sure you want to remove this field?')) {
        const fieldElement = button.closest('.form-field');
        const fieldId = fieldElement.getAttribute('data-field-id');
        
        // Remove from array
        formFields = formFields.filter(f => f.id !== fieldId);
        
        // Remove from DOM
        fieldElement.remove();
        
        // Update form data
        updateFormFieldsData();
        
        // Show empty state if no fields
        if (formFields.length === 0) {
            document.getElementById('formFields').innerHTML = `
                <div class="empty-form-state">
                    <i class="fas fa-puzzle-piece"></i>
                    <h3>Start Building Your Form</h3>
                    <p>Add fields using the buttons above to create your custom feedback form.</p>
                </div>
            `;
        }
    }
}

function moveFieldUp(button) {
    const fieldElement = button.closest('.form-field');
    const previousField = fieldElement.previousElementSibling;
    
    if (previousField && previousField.classList.contains('form-field')) {
        fieldElement.parentNode.insertBefore(fieldElement, previousField);
        reorderFields();
    }
}

function moveFieldDown(button) {
    const fieldElement = button.closest('.form-field');
    const nextField = fieldElement.nextElementSibling;
    
    if (nextField && nextField.classList.contains('form-field')) {
        fieldElement.parentNode.insertBefore(nextField, fieldElement);
        reorderFields();
    }
}

function reorderFields() {
    const fieldElements = document.querySelectorAll('.form-field');
    fieldElements.forEach((element, index) => {
        const fieldId = element.getAttribute('data-field-id');
        const fieldData = formFields.find(f => f.id === fieldId);
        if (fieldData) {
            fieldData.order = index + 1;
        }
    });
    
    // Sort formFields array by order
    formFields.sort((a, b) => a.order - b.order);
    updateFormFieldsData();
}

function updateFormFieldsData() {
    document.getElementById('formFieldsData').value = JSON.stringify(formFields);
}

function previewForm() {
    if (formFields.length === 0) {
        alert('Please add some fields before previewing the form.');
        return;
    }
    
    const previewContent = document.getElementById('formPreviewContent');
    const formName = document.querySelector('input[name="form_name"]').value || 'Feedback Form';
    
    let html = `
        <div class="form-preview">
            <h3>${formName}</h3>
            <form class="preview-form">
    `;
    
    formFields.forEach(field => {
        html += `<div class="form-group ${field.width === 'half' ? 'col-md-6' : field.width === 'third' ? 'col-md-4' : 'col-12'}">`;
        html += `<label class="form-label">${field.label}${field.required ? ' <span class="text-danger">*</span>' : ''}</label>`;
        
        switch (field.type) {
            case 'text':
                html += `<input type="text" class="form-control" placeholder="${field.placeholder || ''}" ${field.required ? 'required' : ''}>`;
                break;
            case 'number':
                html += `<input type="number" class="form-control" placeholder="${field.placeholder || ''}" ${field.required ? 'required' : ''}>`;
                break;
            case 'rating':
                html += `
                    <div class="rating-input">
                        ${Array(field.maxValue || 5).fill(0).map((_, i) => `
                            <label class="rating-star">
                                <input type="radio" name="${field.name}" value="${i + 1}" ${field.required ? 'required' : ''}>
                                <i class="fas fa-star"></i>
                            </label>
                        `).join('')}
                    </div>
                `;
                break;
            case 'dropdown':
                html += `
                    <select class="form-control" ${field.required ? 'required' : ''}>
                        <option value="">Select an option...</option>
                        ${(field.options || []).map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                    </select>
                `;
                break;
            case 'textarea':
                html += `<textarea class="form-control" rows="3" placeholder="${field.placeholder || ''}" ${field.required ? 'required' : ''}></textarea>`;
                break;
        }
        
        if (field.helpText) {
            html += `<small class="form-text text-muted">${field.helpText}</small>`;
        }
        
        html += '</div>';
    });
    
    html += `
            </form>
        </div>
    `;
    
    previewContent.innerHTML = html;
    new bootstrap.Modal(document.getElementById('formPreviewModal')).show();
}

function saveDraft() {
    // Implementation for saving draft
    alert('Draft save functionality will be implemented.');
}

// Auto-generate field name from label
document.getElementById('fieldLabel').addEventListener('input', function() {
    const label = this.value;
    const fieldName = label.toLowerCase()
        .replace(/[^a-z0-9\s]/g, '')
        .replace(/\s+/g, '_')
        .substring(0, 50);
    document.getElementById('fieldName').value = fieldName;
});

// Form submission
document.getElementById('feedbackFormBuilder').addEventListener('submit', function(e) {
    if (formFields.length === 0) {
        e.preventDefault();
        alert('Please add at least one field to the form.');
        return;
    }
    
    updateFormFieldsData();
});

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    updateFormFieldsData();
});
</script>
{% endblock %}